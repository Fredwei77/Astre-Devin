<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ - ä¹ç­®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="mystical-theme.css">
    
    <style>
        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s;
        }
        
        .status-card:hover {
            border-color: rgba(255, 215, 0, 0.6);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
        }
        
        .status-ok {
            color: #22c55e;
        }
        
        .status-warning {
            color: #fbbf24;
        }
        
        .status-error {
            color: #ef4444;
        }
        
        .status-checking {
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-deep-navy via-mystic-purple to-jade-dark min-h-screen text-moon-silver">
    
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-mystic-gold mb-2">
                <i class="fas fa-heartbeat mr-3"></i>æ”¯ä»˜ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
            </h1>
            <p class="text-moon-silver/70">æ£€æŸ¥æ”¯ä»˜ç³»ç»Ÿå„ç»„ä»¶çš„è¿è¡ŒçŠ¶æ€</p>
        </div>

        <!-- æ€»ä½“çŠ¶æ€ -->
        <div class="status-card mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-mystic-gold mb-2">ç³»ç»ŸçŠ¶æ€</h2>
                    <p id="overallStatus" class="text-lg">æ­£åœ¨æ£€æŸ¥...</p>
                </div>
                <div id="overallIcon" class="text-6xl status-checking">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†æ£€æŸ¥é¡¹ -->
        <div id="checkItems"></div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="flex gap-4 mt-8">
            <button onclick="runCheck()" class="flex-1 bg-mystic-gold text-deep-navy py-3 rounded-lg font-semibold hover:bg-yellow-400 transition-colors">
                <i class="fas fa-redo mr-2"></i>é‡æ–°æ£€æŸ¥
            </button>
            <button onclick="window.location.href='test-premium-payment.html'" class="flex-1 bg-gradient-to-r from-jade-dark to-mystic-purple text-moon-silver py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity border border-mystic-gold/30">
                <i class="fas fa-vial mr-2"></i>æ‰“å¼€æµ‹è¯•é¡µé¢
            </button>
        </div>

        <!-- å»ºè®® -->
        <div id="suggestions" class="mt-8"></div>

    </div>

    <script>
        const checks = [
            {
                name: 'Stripe.js åŠ è½½',
                check: () => typeof Stripe !== 'undefined',
                fix: 'è¯·ç¡®ä¿é¡µé¢å·²åŠ è½½ Stripe.js åº“'
            },
            {
                name: 'å¢å¼ºç‰ˆæ”¯ä»˜å®¢æˆ·ç«¯',
                check: () => typeof window.EnhancedStripePaymentService !== 'undefined',
                fix: 'è¯·åŠ è½½ stripe-client-enhanced.js æ–‡ä»¶'
            },
            {
                name: 'è®¢é˜…ç®¡ç†å™¨',
                check: () => typeof window.subscriptionManager !== 'undefined',
                fix: 'è¯·åŠ è½½ subscription-manager.js æ–‡ä»¶'
            },
            {
                name: 'æ”¯ä»˜UIç»„ä»¶',
                check: () => typeof window.showPaymentForm !== 'undefined',
                fix: 'è¯·åŠ è½½ payment-ui.js æ–‡ä»¶'
            },
            {
                name: 'æœ¬åœ°å­˜å‚¨å¯ç”¨',
                check: () => {
                    try {
                        localStorage.setItem('test', 'test');
                        localStorage.removeItem('test');
                        return true;
                    } catch (e) {
                        return false;
                    }
                },
                fix: 'è¯·å¯ç”¨æµè§ˆå™¨çš„æœ¬åœ°å­˜å‚¨åŠŸèƒ½'
            },
            {
                name: 'æµ‹è¯•æ¨¡å¼çŠ¶æ€',
                check: () => {
                    if (window.EnhancedStripePaymentService) {
                        return window.EnhancedStripePaymentService.isTestMode();
                    }
                    return null;
                },
                isInfo: true,
                fix: 'å½“å‰è¿è¡Œæ¨¡å¼'
            }
        ];

        async function checkBackendServer() {
            try {
                const response = await fetch('/api/health', { 
                    method: 'GET',
                    signal: AbortSignal.timeout(3000)
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        async function runCheck() {
            const checkItemsDiv = document.getElementById('checkItems');
            const suggestionsDiv = document.getElementById('suggestions');
            checkItemsDiv.innerHTML = '';
            suggestionsDiv.innerHTML = '';

            let allOk = true;
            let warnings = [];
            let errors = [];

            // æ£€æŸ¥å„é¡¹
            for (const item of checks) {
                const result = item.check();
                const card = document.createElement('div');
                card.className = 'status-card';

                let statusIcon, statusText, statusClass;
                
                if (item.isInfo) {
                    statusIcon = 'fa-info-circle';
                    statusText = result ? 'æµ‹è¯•æ¨¡å¼' : 'ç”Ÿäº§æ¨¡å¼';
                    statusClass = 'status-checking';
                } else if (result) {
                    statusIcon = 'fa-check-circle';
                    statusText = 'æ­£å¸¸';
                    statusClass = 'status-ok';
                } else {
                    statusIcon = 'fa-times-circle';
                    statusText = 'å¼‚å¸¸';
                    statusClass = 'status-error';
                    allOk = false;
                    errors.push({ name: item.name, fix: item.fix });
                }

                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold text-lg mb-1">${item.name}</h3>
                            <p class="text-sm text-moon-silver/70">${item.fix}</p>
                        </div>
                        <div class="text-3xl ${statusClass}">
                            <i class="fas ${statusIcon}"></i>
                        </div>
                    </div>
                `;

                checkItemsDiv.appendChild(card);
            }

            // æ£€æŸ¥åç«¯æœåŠ¡å™¨
            const serverCard = document.createElement('div');
            serverCard.className = 'status-card';
            serverCard.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-lg mb-1">åç«¯æœåŠ¡å™¨</h3>
                        <p class="text-sm text-moon-silver/70">æ£€æŸ¥ä¸­...</p>
                    </div>
                    <div class="text-3xl status-checking">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                </div>
            `;
            checkItemsDiv.appendChild(serverCard);

            const serverOk = await checkBackendServer();
            
            if (serverOk) {
                serverCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold text-lg mb-1">åç«¯æœåŠ¡å™¨</h3>
                            <p class="text-sm text-moon-silver/70">æœåŠ¡å™¨è¿è¡Œæ­£å¸¸</p>
                        </div>
                        <div class="text-3xl status-ok">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                `;
            } else {
                serverCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold text-lg mb-1">åç«¯æœåŠ¡å™¨</h3>
                            <p class="text-sm text-moon-silver/70">æœåŠ¡å™¨æœªè¿è¡Œï¼ˆå°†ä½¿ç”¨æµ‹è¯•æ¨¡å¼ï¼‰</p>
                        </div>
                        <div class="text-3xl status-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                `;
                warnings.push({
                    name: 'åç«¯æœåŠ¡å™¨',
                    fix: 'è¿è¡Œ npm start æˆ– start.bat å¯åŠ¨æœåŠ¡å™¨'
                });
            }

            // æ›´æ–°æ€»ä½“çŠ¶æ€
            const overallIcon = document.getElementById('overallIcon');
            const overallStatus = document.getElementById('overallStatus');

            if (allOk && serverOk) {
                overallIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                overallIcon.className = 'text-6xl status-ok';
                overallStatus.textContent = 'æ‰€æœ‰ç³»ç»Ÿæ­£å¸¸è¿è¡Œ';
                overallStatus.className = 'text-lg status-ok';
            } else if (allOk && !serverOk) {
                overallIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                overallIcon.className = 'text-6xl status-warning';
                overallStatus.textContent = 'æµ‹è¯•æ¨¡å¼å¯ç”¨ï¼ˆåç«¯æœåŠ¡å™¨æœªè¿è¡Œï¼‰';
                overallStatus.className = 'text-lg status-warning';
            } else {
                overallIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
                overallIcon.className = 'text-6xl status-error';
                overallStatus.textContent = 'å‘ç°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦æƒ…';
                overallStatus.className = 'text-lg status-error';
            }

            // æ˜¾ç¤ºå»ºè®®
            if (errors.length > 0 || warnings.length > 0) {
                let suggestionsHTML = '<div class="status-card"><h3 class="text-xl font-bold text-mystic-gold mb-4"><i class="fas fa-lightbulb mr-2"></i>ä¿®å¤å»ºè®®</h3>';
                
                if (errors.length > 0) {
                    suggestionsHTML += '<div class="mb-4"><h4 class="font-semibold text-red-400 mb-2">é”™è¯¯ï¼š</h4><ul class="list-disc list-inside space-y-2">';
                    errors.forEach(error => {
                        suggestionsHTML += `<li><strong>${error.name}</strong>: ${error.fix}</li>`;
                    });
                    suggestionsHTML += '</ul></div>';
                }

                if (warnings.length > 0) {
                    suggestionsHTML += '<div><h4 class="font-semibold text-yellow-400 mb-2">è­¦å‘Šï¼š</h4><ul class="list-disc list-inside space-y-2">';
                    warnings.forEach(warning => {
                        suggestionsHTML += `<li><strong>${warning.name}</strong>: ${warning.fix}</li>`;
                    });
                    suggestionsHTML += '</ul></div>';
                }

                suggestionsHTML += '</div>';
                suggestionsDiv.innerHTML = suggestionsHTML;
            } else {
                suggestionsDiv.innerHTML = `
                    <div class="status-card text-center">
                        <div class="text-4xl mb-3">ğŸ‰</div>
                        <h3 class="text-xl font-bold text-green-400 mb-2">ä¸€åˆ‡å°±ç»ªï¼</h3>
                        <p class="text-moon-silver/70">æ”¯ä»˜ç³»ç»Ÿå·²å‡†å¤‡å¥½è¿›è¡Œæµ‹è¯•</p>
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('DOMContentLoaded', () => {
            // åŠ è½½å¿…è¦çš„è„šæœ¬
            const scripts = [
                'stripe-client-enhanced.js',
                'subscription-manager.js',
                'payment-ui.js'
            ];

            let loadedCount = 0;
            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    loadedCount++;
                    if (loadedCount === scripts.length) {
                        setTimeout(runCheck, 500);
                    }
                };
                script.onerror = () => {
                    loadedCount++;
                    if (loadedCount === scripts.length) {
                        setTimeout(runCheck, 500);
                    }
                };
                document.body.appendChild(script);
            });
        });
    </script>

</body>
</html>
