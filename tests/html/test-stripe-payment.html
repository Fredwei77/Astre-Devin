<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe æ”¯ä»˜æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">ğŸ’³ Stripe æ”¯ä»˜åŠŸèƒ½æµ‹è¯•</h1>

        <!-- æµ‹è¯•çŠ¶æ€ -->
        <div id="testStatus" class="mb-6 p-4 rounded-lg bg-blue-900/50">
            <h2 class="text-xl font-bold mb-2">æµ‹è¯•çŠ¶æ€</h2>
            <div id="statusList" class="space-y-2 text-sm"></div>
        </div>

        <!-- Stripe åˆå§‹åŒ–çŠ¶æ€ -->
        <div class="mb-6 p-4 rounded-lg bg-gray-800">
            <h2 class="text-xl font-bold mb-2">Stripe çŠ¶æ€</h2>
            <div id="stripeStatus" class="text-sm">æ£€æŸ¥ä¸­...</div>
        </div>

        <!-- æµ‹è¯•å¡ç‰‡ä¿¡æ¯ -->
        <div class="mb-6 p-4 rounded-lg bg-yellow-900/30 border border-yellow-600">
            <h2 class="text-xl font-bold mb-2">ğŸ§ª æµ‹è¯•å¡ç‰‡ä¿¡æ¯</h2>
            <div class="space-y-2 text-sm">
                <div><strong>æˆåŠŸæ”¯ä»˜:</strong> 4242 4242 4242 4242</div>
                <div><strong>éœ€è¦éªŒè¯:</strong> 4000 0025 0000 3155</div>
                <div><strong>æ”¯ä»˜å¤±è´¥:</strong> 4000 0000 0000 9995</div>
                <div><strong>è¿‡æœŸæ—¥æœŸ:</strong> ä»»æ„æœªæ¥æ—¥æœŸ (å¦‚ 12/34)</div>
                <div><strong>CVC:</strong> ä»»æ„3ä½æ•°å­— (å¦‚ 123)</div>
                <div><strong>é‚®ç¼–:</strong> ä»»æ„5ä½æ•°å­— (å¦‚ 12345)</div>
            </div>
        </div>

        <!-- æµ‹è¯•æŒ‰é’® -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button id="testSubscription" class="bg-blue-600 px-6 py-3 rounded-lg hover:bg-blue-700">
                æµ‹è¯•ä¼šå‘˜è®¢é˜…
            </button>
            <button id="testProductPurchase" class="bg-green-600 px-6 py-3 rounded-lg hover:bg-green-700">
                æµ‹è¯•å•†å“è´­ä¹°
            </button>
        </div>

        <!-- æ”¯ä»˜è¡¨å•å®¹å™¨ -->
        <div id="paymentFormContainer" class="hidden mb-6 p-6 rounded-lg bg-gray-800">
            <h2 class="text-xl font-bold mb-4">æ”¯ä»˜æµ‹è¯•</h2>
            <form id="testPaymentForm" class="space-y-4">
                <div>
                    <label class="block mb-2">å§“å</label>
                    <input type="text" id="testName" value="Test User" required
                        class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                </div>
                <div>
                    <label class="block mb-2">é‚®ç®±</label>
                    <input type="email" id="testEmail" value="test@example.com" required
                        class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2">
                </div>
                <div>
                    <label class="block mb-2">å¡ç‰‡ä¿¡æ¯</label>
                    <div id="card-element-test" class="bg-gray-700 border border-gray-600 rounded px-4 py-3"></div>
                    <div id="card-errors-test" class="text-red-400 text-sm mt-2"></div>
                </div>
                <button type="submit" id="submitTest"
                    class="w-full bg-yellow-600 px-6 py-3 rounded-lg hover:bg-yellow-700 disabled:opacity-50">
                    <span id="submitText">æäº¤æ”¯ä»˜</span>
                    <span id="submitSpinner" class="hidden">
                        <i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­...
                    </span>
                </button>
            </form>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div id="testResult" class="hidden p-6 rounded-lg bg-gray-800">
            <h2 class="text-xl font-bold mb-4">æµ‹è¯•ç»“æœ</h2>
            <pre id="resultContent" class="bg-gray-900 p-4 rounded text-sm overflow-auto"></pre>
        </div>
    </div>

    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="supabase-init.js"></script>
    
    <!-- Stripe å®¢æˆ·ç«¯ -->
    <script src="stripe-client.js"></script>
    
    <!-- å•†åº—æœåŠ¡ -->
    <script src="shop-service.js"></script>

    <script>
        // æµ‹è¯•æ—¥å¿—
        function addLog(message, type = 'info') {
            const statusList = document.getElementById('statusList');
            const colors = {
                success: 'text-green-400',
                error: 'text-red-400',
                info: 'text-blue-400',
                warning: 'text-yellow-400'
            };
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸',
                warning: 'âš ï¸'
            };
            const log = document.createElement('div');
            log.className = colors[type];
            log.textContent = `${icons[type]} ${new Date().toLocaleTimeString()} - ${message}`;
            statusList.appendChild(log);
            console.log(message);
        }

        // ç­‰å¾…åˆå§‹åŒ–
        async function waitForInit() {
            let attempts = 0;
            while (!window.StripePaymentService && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            if (!window.StripePaymentService) {
                throw new Error('Stripe æœåŠ¡åˆå§‹åŒ–è¶…æ—¶');
            }
        }

        // æ£€æŸ¥ Stripe çŠ¶æ€
        async function checkStripeStatus() {
            try {
                await waitForInit();
                const stripe = window.StripePaymentService.getStripe();
                const stripeStatus = document.getElementById('stripeStatus');
                
                if (stripe) {
                    stripeStatus.innerHTML = '<div class="text-green-400">âœ… Stripe å·²åˆå§‹åŒ–</div>';
                    addLog('Stripe å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                } else {
                    stripeStatus.innerHTML = '<div class="text-red-400">âŒ Stripe æœªåˆå§‹åŒ–</div>';
                    addLog('Stripe å®¢æˆ·ç«¯æœªåˆå§‹åŒ–', 'error');
                }
            } catch (error) {
                addLog('æ£€æŸ¥ Stripe çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•ä¼šå‘˜è®¢é˜…
        document.getElementById('testSubscription').addEventListener('click', () => {
            addLog('å¼€å§‹æµ‹è¯•ä¼šå‘˜è®¢é˜…...', 'info');
            document.getElementById('paymentFormContainer').classList.remove('hidden');
            document.getElementById('testResult').classList.add('hidden');
            
            // åˆ›å»ºå¡ç‰‡å…ƒç´ 
            setTimeout(() => {
                const cardElement = window.createPaymentElements('card-element-test');
                if (cardElement) {
                    addLog('æ”¯ä»˜å…ƒç´ å·²åˆ›å»º', 'success');
                    cardElement.on('change', (event) => {
                        const displayError = document.getElementById('card-errors-test');
                        if (event.error) {
                            displayError.textContent = event.error.message;
                        } else {
                            displayError.textContent = '';
                        }
                    });
                }
            }, 100);
        });

        // æµ‹è¯•å•†å“è´­ä¹°
        document.getElementById('testProductPurchase').addEventListener('click', async () => {
            addLog('å¼€å§‹æµ‹è¯•å•†å“è´­ä¹°...', 'info');
            
            try {
                // è·å–æµ‹è¯•å•†å“
                const result = await window.ShopService.products.getAll();
                if (result.success && result.data.length > 0) {
                    const product = result.data[0];
                    addLog(`æµ‹è¯•å•†å“: ${product.name_en || product.name}`, 'info');
                    
                    // æ˜¾ç¤ºæ”¯ä»˜è¡¨å•
                    document.getElementById('paymentFormContainer').classList.remove('hidden');
                    document.getElementById('testResult').classList.add('hidden');
                    
                    setTimeout(() => {
                        const cardElement = window.createPaymentElements('card-element-test');
                        if (cardElement) {
                            addLog('æ”¯ä»˜å…ƒç´ å·²åˆ›å»º', 'success');
                        }
                    }, 100);
                } else {
                    addLog('æ²¡æœ‰å¯ç”¨çš„æµ‹è¯•å•†å“', 'warning');
                }
            } catch (error) {
                addLog('è·å–æµ‹è¯•å•†å“å¤±è´¥: ' + error.message, 'error');
            }
        });

        // è¡¨å•æäº¤
        document.getElementById('testPaymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitTest');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');
            
            submitButton.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');
            
            try {
                addLog('åˆ›å»ºæµ‹è¯•æ”¯ä»˜...', 'info');
                
                // åˆ›å»ºæ”¯ä»˜æ„å›¾
                const result = await window.StripePaymentService.createPaymentIntent(
                    1000, // $10.00
                    'usd',
                    { test: true }
                );
                
                if (result.success) {
                    addLog('æ”¯ä»˜æ„å›¾åˆ›å»ºæˆåŠŸ', 'success');
                    
                    // ç¡®è®¤æ”¯ä»˜
                    const confirmResult = await window.StripePaymentService.confirmPayment(
                        result.clientSecret,
                        {
                            name: document.getElementById('testName').value,
                            email: document.getElementById('testEmail').value
                        }
                    );
                    
                    if (confirmResult.success) {
                        addLog('æ”¯ä»˜ç¡®è®¤æˆåŠŸ', 'success');
                        showResult(confirmResult.paymentIntent);
                    } else {
                        throw new Error(confirmResult.error);
                    }
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                addLog('æ”¯ä»˜å¤±è´¥: ' + error.message, 'error');
                alert('æ”¯ä»˜å¤±è´¥: ' + error.message);
            } finally {
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        });

        // æ˜¾ç¤ºç»“æœ
        function showResult(data) {
            document.getElementById('testResult').classList.remove('hidden');
            document.getElementById('resultContent').textContent = JSON.stringify(data, null, 2);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            addLog('é¡µé¢åŠ è½½å®Œæˆ', 'info');
            await checkStripeStatus();
        });
    </script>
</body>
</html>
