<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†åº— Stripe æ”¯ä»˜é›†æˆæµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="mystical-theme.css">
</head>
<body class="bg-gradient-to-br from-deep-navy via-mystic-purple to-deep-navy min-h-screen text-warm-white">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-mystic-gold mb-8 text-center">
            <i class="fas fa-shopping-cart mr-2"></i>
            å•†åº— Stripe æ”¯ä»˜é›†æˆæµ‹è¯•
        </h1>

        <!-- æµ‹è¯•çŠ¶æ€ -->
        <div id="testStatus" class="mb-8 p-6 bg-white/10 rounded-lg border border-mystic-gold/30">
            <h2 class="text-xl font-semibold mb-4 text-mystic-gold">æµ‹è¯•çŠ¶æ€</h2>
            <div id="statusList" class="space-y-2"></div>
        </div>

        <!-- æµ‹è¯•æŒ‰é’® -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <button onclick="testStripeInit()" 
                    class="bg-mystic-gold/20 text-mystic-gold px-6 py-4 rounded-lg font-semibold hover:bg-mystic-gold/30 transition-colors">
                <i class="fas fa-check-circle mr-2"></i>
                1. æµ‹è¯• Stripe åˆå§‹åŒ–
            </button>

            <button onclick="testShopUIInit()" 
                    class="bg-mystic-gold/20 text-mystic-gold px-6 py-4 rounded-lg font-semibold hover:bg-mystic-gold/30 transition-colors">
                <i class="fas fa-check-circle mr-2"></i>
                2. æµ‹è¯• ShopUI åˆå§‹åŒ–
            </button>

            <button onclick="testCheckoutFlow()" 
                    class="bg-mystic-gold/20 text-mystic-gold px-6 py-4 rounded-lg font-semibold hover:bg-mystic-gold/30 transition-colors">
                <i class="fas fa-shopping-bag mr-2"></i>
                3. æµ‹è¯•ç»“è´¦æµç¨‹
            </button>

            <button onclick="testStripePayment()" 
                    class="bg-mystic-gold text-deep-navy px-6 py-4 rounded-lg font-semibold hover:bg-yellow-400 transition-colors">
                <i class="fas fa-credit-card mr-2"></i>
                4. æµ‹è¯• Stripe æ”¯ä»˜
            </button>
        </div>

        <!-- æµ‹è¯•å•†å“ -->
        <div id="testProducts" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- å•†å“å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>

        <!-- è´­ç‰©è½¦æŒ‰é’® -->
        <div class="fixed bottom-8 right-8">
            <button id="viewCartBtn" onclick="shopUI.viewCart()" 
                    class="bg-mystic-gold text-deep-navy px-6 py-3 rounded-full shadow-lg hover:bg-yellow-400 transition-colors">
                <i class="fas fa-shopping-cart mr-2"></i>
                è´­ç‰©è½¦ (<span id="cartCount">0</span>)
            </button>
        </div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="config.js"></script>
    <script src="supabase-client.js"></script>
    <script src="auth-service.js"></script>
    <script src="stripe-client.js"></script>
    <script src="shop-service.js"></script>
    <script src="shop-ui.js"></script>

    <script>
        // æµ‹è¯•å·¥å…·å‡½æ•°
        function addStatus(message, type = 'info') {
            const statusList = document.getElementById('statusList');
            const colors = {
                success: 'text-green-400',
                error: 'text-red-400',
                info: 'text-blue-400',
                warning: 'text-yellow-400'
            };
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };

            const statusItem = document.createElement('div');
            statusItem.className = `${colors[type]} text-sm`;
            statusItem.innerHTML = `
                <i class="fas ${icons[type]} mr-2"></i>
                <span>${new Date().toLocaleTimeString()}</span> - ${message}
            `;
            statusList.appendChild(statusItem);
            statusList.scrollTop = statusList.scrollHeight;
        }

        // æµ‹è¯• 1: Stripe åˆå§‹åŒ–
        async function testStripeInit() {
            addStatus('å¼€å§‹æµ‹è¯• Stripe åˆå§‹åŒ–...', 'info');
            
            try {
                if (typeof Stripe === 'undefined') {
                    throw new Error('Stripe.js æœªåŠ è½½');
                }
                addStatus('âœ“ Stripe.js å·²åŠ è½½', 'success');

                if (!window.StripePaymentService) {
                    throw new Error('StripePaymentService æœªåˆå§‹åŒ–');
                }
                addStatus('âœ“ StripePaymentService å·²åˆå§‹åŒ–', 'success');

                const stripe = window.StripePaymentService.getStripe();
                if (!stripe) {
                    throw new Error('Stripe å®ä¾‹æœªåˆ›å»º');
                }
                addStatus('âœ“ Stripe å®ä¾‹å·²åˆ›å»º', 'success');

                addStatus('Stripe åˆå§‹åŒ–æµ‹è¯•é€šè¿‡ï¼', 'success');
            } catch (error) {
                addStatus('âœ— Stripe åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯• 2: ShopUI åˆå§‹åŒ–
        async function testShopUIInit() {
            addStatus('å¼€å§‹æµ‹è¯• ShopUI åˆå§‹åŒ–...', 'info');
            
            try {
                if (!window.shopUI) {
                    throw new Error('ShopUI æœªåˆå§‹åŒ–');
                }
                addStatus('âœ“ ShopUI å·²åˆå§‹åŒ–', 'success');

                if (typeof window.shopUI.handleCheckout !== 'function') {
                    throw new Error('handleCheckout æ–¹æ³•ä¸å­˜åœ¨');
                }
                addStatus('âœ“ handleCheckout æ–¹æ³•å­˜åœ¨', 'success');

                if (typeof window.shopUI.showStripePayment !== 'function') {
                    throw new Error('showStripePayment æ–¹æ³•ä¸å­˜åœ¨');
                }
                addStatus('âœ“ showStripePayment æ–¹æ³•å­˜åœ¨', 'success');

                if (typeof window.shopUI.processStripePayment !== 'function') {
                    throw new Error('processStripePayment æ–¹æ³•ä¸å­˜åœ¨');
                }
                addStatus('âœ“ processStripePayment æ–¹æ³•å­˜åœ¨', 'success');

                addStatus('ShopUI åˆå§‹åŒ–æµ‹è¯•é€šè¿‡ï¼', 'success');
            } catch (error) {
                addStatus('âœ— ShopUI åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯• 3: ç»“è´¦æµç¨‹
        async function testCheckoutFlow() {
            addStatus('å¼€å§‹æµ‹è¯•ç»“è´¦æµç¨‹...', 'info');
            
            try {
                // åˆ›å»ºæµ‹è¯•å•†å“
                const testProduct = {
                    id: 'test-product',
                    name: 'æµ‹è¯•å•†å“',
                    name_en: 'Test Product',
                    description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å•†å“',
                    price: 29.99,
                    icon: 'ğŸ',
                    stock: 10
                };

                const testItems = [{
                    product: testProduct,
                    quantity: 1
                }];

                addStatus('âœ“ æµ‹è¯•å•†å“å·²åˆ›å»º', 'success');

                // æ¨¡æ‹Ÿç‚¹å‡»"ç«‹å³è´­ä¹°"
                window.shopUI.selectedProduct = testProduct;
                addStatus('âœ“ å•†å“å·²é€‰æ‹©', 'success');

                // æ˜¾ç¤ºç»“è´¦æ¨¡æ€æ¡†
                await window.shopUI.showCheckoutModal(testItems);
                addStatus('âœ“ ç»“è´¦æ¨¡æ€æ¡†å·²æ˜¾ç¤º', 'success');

                addStatus('ç»“è´¦æµç¨‹æµ‹è¯•é€šè¿‡ï¼è¯·å¡«å†™è¡¨å•å¹¶æäº¤', 'success');
            } catch (error) {
                addStatus('âœ— ç»“è´¦æµç¨‹æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯• 4: Stripe æ”¯ä»˜
        async function testStripePayment() {
            addStatus('å¼€å§‹æµ‹è¯• Stripe æ”¯ä»˜...', 'info');
            
            try {
                // åˆ›å»ºæµ‹è¯•è®¢å•æ•°æ®
                const testOrderData = {
                    total_amount: 39.99,
                    shipping_fee: 10.00,
                    recipient_name: 'æµ‹è¯•ç”¨æˆ·',
                    recipient_phone: '1234567890',
                    shipping_address: 'æµ‹è¯•åœ°å€',
                    shipping_city: 'æµ‹è¯•åŸå¸‚',
                    shipping_province: 'æµ‹è¯•çœä»½',
                    shipping_postal_code: '100000',
                    notes: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è®¢å•',
                    status: 'pending'
                };

                const testItems = [{
                    product: {
                        id: 'test-product',
                        name: 'æµ‹è¯•å•†å“',
                        name_en: 'Test Product',
                        price: 29.99,
                        icon: 'ğŸ'
                    },
                    quantity: 1
                }];

                addStatus('âœ“ æµ‹è¯•è®¢å•æ•°æ®å·²åˆ›å»º', 'success');

                // æ˜¾ç¤º Stripe æ”¯ä»˜é¡µé¢
                window.shopUI.showStripePayment(testItems, 39.99, testOrderData);
                addStatus('âœ“ Stripe æ”¯ä»˜é¡µé¢å·²æ˜¾ç¤º', 'success');

                addStatus('Stripe æ”¯ä»˜æµ‹è¯•å‡†å¤‡å®Œæˆï¼', 'success');
                addStatus('è¯·ä½¿ç”¨æµ‹è¯•å¡å·: 4242 4242 4242 4242', 'info');
                addStatus('åˆ°æœŸæ—¥æœŸ: ä»»æ„æœªæ¥æ—¥æœŸ (å¦‚ 12/34)', 'info');
                addStatus('CVC: ä»»æ„3ä½æ•°å­— (å¦‚ 123)', 'info');
            } catch (error) {
                addStatus('âœ— Stripe æ”¯ä»˜æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæµ‹è¯•å•†å“
        window.addEventListener('DOMContentLoaded', () => {
            addStatus('é¡µé¢åŠ è½½å®Œæˆ', 'success');
            addStatus('ç­‰å¾… ShopUI åˆå§‹åŒ–...', 'info');

            setTimeout(() => {
                if (window.shopUI) {
                    addStatus('ShopUI å·²å°±ç»ª', 'success');
                    displayTestProducts();
                } else {
                    addStatus('ShopUI æœªåˆå§‹åŒ–', 'warning');
                }
            }, 1000);
        });

        // æ˜¾ç¤ºæµ‹è¯•å•†å“
        function displayTestProducts() {
            const container = document.getElementById('testProducts');
            const testProducts = [
                { id: 'test-1', name: 'æµ‹è¯•å•†å“ 1', name_en: 'Test Product 1', price: 19.99, icon: 'ğŸ', stock: 10 },
                { id: 'test-2', name: 'æµ‹è¯•å•†å“ 2', name_en: 'Test Product 2', price: 29.99, icon: 'ğŸ’', stock: 5 },
                { id: 'test-3', name: 'æµ‹è¯•å•†å“ 3', name_en: 'Test Product 3', price: 39.99, icon: 'ğŸ‰', stock: 3 }
            ];

            container.innerHTML = testProducts.map(product => `
                <div class="bg-white/5 rounded-lg p-4 text-center hover:bg-white/10 transition-all">
                    <div class="text-4xl mb-3">${product.icon}</div>
                    <h4 class="font-semibold mb-1">${product.name_en}</h4>
                    <div class="text-mystic-gold font-semibold text-lg mb-2">${product.price}</div>
                    <div class="text-xs text-moon-silver mb-3">åº“å­˜: ${product.stock}</div>
                    <button onclick="testBuyProduct('${product.id}')" 
                            class="w-full bg-mystic-gold text-deep-navy px-3 py-2 rounded-lg text-sm font-medium hover:bg-yellow-400 transition-colors">
                        ç«‹å³è´­ä¹°
                    </button>
                </div>
            `).join('');
        }

        // æµ‹è¯•è´­ä¹°å•†å“
        async function testBuyProduct(productId) {
            addStatus(`æµ‹è¯•è´­ä¹°å•†å“: ${productId}`, 'info');
            
            const testProduct = {
                id: productId,
                name: 'æµ‹è¯•å•†å“',
                name_en: 'Test Product',
                description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å•†å“',
                price: 29.99,
                icon: 'ğŸ',
                stock: 10
            };

            window.shopUI.selectedProduct = testProduct;
            await window.shopUI.showCheckoutModal([{ product: testProduct, quantity: 1 }]);
        }
    </script>
</body>
</html>
