<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe æ”¯ä»˜è¯Šæ–­</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">ğŸ” Stripe æ”¯ä»˜è¯Šæ–­å·¥å…·</h1>

        <div id="results" class="space-y-4"></div>

        <button id="runDiagnostics" class="mt-6 bg-blue-600 px-6 py-3 rounded-lg hover:bg-blue-700">
            è¿è¡Œè¯Šæ–­
        </button>
    </div>

    <script>
        function addResult(title, status, message, details = '') {
            const results = document.getElementById('results');
            const colors = {
                success: 'bg-green-900/50 border-green-600',
                error: 'bg-red-900/50 border-red-600',
                warning: 'bg-yellow-900/50 border-yellow-600',
                info: 'bg-blue-900/50 border-blue-600'
            };
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            const div = document.createElement('div');
            div.className = `p-4 rounded-lg border-2 ${colors[status]}`;
            div.innerHTML = `
                <div class="flex items-start gap-3">
                    <span class="text-2xl">${icons[status]}</span>
                    <div class="flex-1">
                        <h3 class="font-bold text-lg mb-1">${title}</h3>
                        <p class="text-sm mb-2">${message}</p>
                        ${details ? `<pre class="text-xs bg-black/30 p-2 rounded overflow-auto">${details}</pre>` : ''}
                    </div>
                </div>
            `;
            results.appendChild(div);
        }

        async function runDiagnostics() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="text-center text-gray-400">æ­£åœ¨è¿è¡Œè¯Šæ–­...</div>';

            // 1. æ£€æŸ¥æœåŠ¡å™¨è¿æ¥
            try {
                const response = await fetch('http://localhost:3000/api/health');
                if (response.ok) {
                    addResult('æœåŠ¡å™¨è¿æ¥', 'success', 'æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ');
                } else {
                    addResult('æœåŠ¡å™¨è¿æ¥', 'error', `æœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status}`);
                }
            } catch (error) {
                addResult('æœåŠ¡å™¨è¿æ¥', 'error', 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨', error.message);
                addResult('è§£å†³æ–¹æ¡ˆ', 'info', 'è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ', 'npm start');
                return;
            }

            // 2. æ£€æŸ¥ Stripe API è·¯ç”±
            try {
                const response = await fetch('http://localhost:3000/api/stripe/test', {
                    method: 'GET'
                });
                
                if (response.status === 404) {
                    addResult('Stripe è·¯ç”±', 'error', 'Stripe API è·¯ç”±æœªæ‰¾åˆ°', 
                        'å¯èƒ½åŸå› :\n1. stripe-api.js æœªæ­£ç¡®åŠ è½½\n2. server.js ä¸­æœªæ­£ç¡®å¼•å…¥è·¯ç”±');
                } else {
                    addResult('Stripe è·¯ç”±', 'success', 'Stripe API è·¯ç”±å¯è®¿é—®');
                }
            } catch (error) {
                addResult('Stripe è·¯ç”±', 'error', 'æ£€æŸ¥ Stripe è·¯ç”±å¤±è´¥', error.message);
            }

            // 3. æµ‹è¯•åˆ›å»ºæ”¯ä»˜æ„å›¾
            try {
                const response = await fetch('http://localhost:3000/api/stripe/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 1000,
                        currency: 'usd'
                    })
                });

                const data = await response.json();

                if (response.ok && data.clientSecret) {
                    addResult('åˆ›å»ºæ”¯ä»˜æ„å›¾', 'success', 'æ”¯ä»˜æ„å›¾åˆ›å»ºæˆåŠŸ', 
                        JSON.stringify(data, null, 2));
                } else {
                    addResult('åˆ›å»ºæ”¯ä»˜æ„å›¾', 'error', 'åˆ›å»ºæ”¯ä»˜æ„å›¾å¤±è´¥', 
                        JSON.stringify(data, null, 2));
                }
            } catch (error) {
                addResult('åˆ›å»ºæ”¯ä»˜æ„å›¾', 'error', 'è¯·æ±‚å¤±è´¥', error.message);
            }

            // 4. æ£€æŸ¥ Stripe å¯†é’¥
            addResult('Stripe å¯†é’¥', 'info', 'è¯·æ£€æŸ¥ .env æ–‡ä»¶', 
                'STRIPE_SECRET_KEY=sk_test_...\nNEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...');

            // 5. æ£€æŸ¥ CORS
            addResult('CORS é…ç½®', 'info', 'å¦‚æœä»æ–‡ä»¶ç³»ç»Ÿæ‰“å¼€é¡µé¢ï¼Œå¯èƒ½ä¼šé‡åˆ° CORS é—®é¢˜', 
                'å»ºè®®:\n1. é€šè¿‡ http://localhost:3000 è®¿é—®\n2. æˆ–ä½¿ç”¨ Live Server æ‰©å±•');
        }

        document.getElementById('runDiagnostics').addEventListener('click', runDiagnostics);

        // è‡ªåŠ¨è¿è¡Œ
        window.addEventListener('load', runDiagnostics);
    </script>
</body>
</html>
