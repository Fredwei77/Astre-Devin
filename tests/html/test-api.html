<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API æµ‹è¯•å·¥å…· - Destiny AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%);
            min-height: 100vh;
        }
        .test-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
    </style>
</head>
<body class="text-white p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-bold mb-8 text-center">ğŸ§ª API æµ‹è¯•å·¥å…·</h1>
        
        <!-- é…ç½®åŒºåŸŸ -->
        <div class="test-card rounded-xl p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">âš™ï¸ é…ç½®</h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block mb-2">API Key:</label>
                    <input type="password" id="apiKey" 
                           class="w-full bg-white/10 border border-white/30 rounded px-4 py-2"
                           placeholder="sk-or-v1-...">
                </div>
                <div>
                    <label class="block mb-2">æ¨¡å‹:</label>
                    <select id="model" class="w-full bg-white/10 border border-white/30 rounded px-4 py-2">
                        <option value="deepseek/deepseek-chat">DeepSeek Chat (æ¨è)</option>
                        <option value="google/gemini-pro-1.5">Gemini Pro 1.5 (å¿«é€Ÿ)</option>
                        <option value="google/gemini-flash-1.5">Gemini Flash 1.5 (è¶…å¿«)</option>
                        <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                        <option value="openai/gpt-4-turbo-preview">GPT-4 Turbo</option>
                    </select>
                </div>
            </div>
            <div class="mt-4">
                <label class="flex items-center">
                    <input type="checkbox" id="mockMode" class="mr-2">
                    <span>ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼ï¼ˆä¸æ¶ˆè€—APIé¢åº¦ï¼‰</span>
                </label>
            </div>
        </div>
        
        <!-- æµ‹è¯•æŒ‰é’® -->
        <div class="test-card rounded-xl p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">ğŸ¯ å¿«é€Ÿæµ‹è¯•</h2>
            <div class="grid md:grid-cols-3 gap-4">
                <button onclick="testConnection()" 
                        class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold">
                    æµ‹è¯•è¿æ¥
                </button>
                <button onclick="testDivination()" 
                        class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg font-semibold">
                    æµ‹è¯•å åœ
                </button>
                <button onclick="testFengShui()" 
                        class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold">
                    æµ‹è¯•é£æ°´
                </button>
                <button onclick="testIChing()" 
                        class="bg-yellow-600 hover:bg-yellow-700 px-6 py-3 rounded-lg font-semibold">
                    æµ‹è¯•æ˜“ç»
                </button>
                <button onclick="clearLogs()" 
                        class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold">
                    æ¸…ç©ºæ—¥å¿—
                </button>
                <button onclick="exportLogs()" 
                        class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold">
                    å¯¼å‡ºæ—¥å¿—
                </button>
            </div>
        </div>
        
        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="test-card rounded-xl p-6">
            <h2 class="text-2xl font-bold mb-4">ğŸ“‹ æµ‹è¯•æ—¥å¿—</h2>
            <div id="logs" class="bg-black/50 rounded p-4 h-96 overflow-y-auto">
                <div class="log-entry info">ç­‰å¾…æµ‹è¯•...</div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="test-card rounded-xl p-6 mt-6">
            <h2 class="text-2xl font-bold mb-4">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h2>
            <div class="grid md:grid-cols-4 gap-4 text-center">
                <div>
                    <div class="text-3xl font-bold" id="totalTests">0</div>
                    <div class="text-sm text-gray-300">æ€»æµ‹è¯•æ•°</div>
                </div>
                <div>
                    <div class="text-3xl font-bold text-green-400" id="successTests">0</div>
                    <div class="text-sm text-gray-300">æˆåŠŸ</div>
                </div>
                <div>
                    <div class="text-3xl font-bold text-red-400" id="failedTests">0</div>
                    <div class="text-sm text-gray-300">å¤±è´¥</div>
                </div>
                <div>
                    <div class="text-3xl font-bold text-blue-400" id="avgTime">0ms</div>
                    <div class="text-sm text-gray-300">å¹³å‡è€—æ—¶</div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="config.js"></script>
    <script src="ai-service.js"></script>
    
    <script>
        let stats = {
            total: 0,
            success: 0,
            failed: 0,
            times: []
        };
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function updateStats() {
            document.getElementById('totalTests').textContent = stats.total;
            document.getElementById('successTests').textContent = stats.success;
            document.getElementById('failedTests').textContent = stats.failed;
            
            if (stats.times.length > 0) {
                const avg = stats.times.reduce((a, b) => a + b, 0) / stats.times.length;
                document.getElementById('avgTime').textContent = Math.round(avg) + 'ms';
            }
        }
        
        function updateConfig() {
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('model').value;
            const mockMode = document.getElementById('mockMode').checked;
            
            if (apiKey) {
                CONFIG.OPENROUTER_API_KEY = apiKey;
            }
            CONFIG.AI_MODEL = model;
            CONFIG.FEATURES.MOCK_MODE = mockMode;
            
            // ç¡®ä¿ MODELS å¯¹è±¡å­˜åœ¨
            if (!CONFIG.MODELS) {
                CONFIG.MODELS = {
                    DIVINATION: model,
                    FENGSHUI: model,
                    ICHING: model
                };
            }
            
            // é‡æ–°åˆ›å»º aiService å®ä¾‹
            window.aiService = new AIService();
            
            log('é…ç½®å·²æ›´æ–°', 'info');
        }
        
        async function testConnection() {
            try {
                // æ£€æŸ¥ aiService æ˜¯å¦å­˜åœ¨
                if (!window.aiService) {
                    log('âŒ AI æœåŠ¡æœªåˆå§‹åŒ–ï¼Œæ­£åœ¨åˆå§‹åŒ–...', 'error');
                    updateConfig();
                }
                
                log('å¼€å§‹æµ‹è¯•è¿æ¥...', 'info');
                stats.total++;
                
                const startTime = Date.now();
                
                const result = await window.aiService.testConnection();
                const duration = Date.now() - startTime;
                stats.times.push(duration);
                
                if (result.success) {
                    stats.success++;
                    log(`âœ… è¿æ¥æˆåŠŸï¼è€—æ—¶: ${duration}ms`, 'success');
                    log(`å“åº”: ${JSON.stringify(result.response)}`, 'success');
                } else {
                    stats.failed++;
                    log(`âŒ è¿æ¥å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                stats.failed++;
                log(`âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
            }
            
            updateStats();
        }
        
        async function testDivination() {
            try {
                // æ£€æŸ¥ aiService æ˜¯å¦å­˜åœ¨
                if (!window.aiService) {
                    log('âŒ AI æœåŠ¡æœªåˆå§‹åŒ–ï¼Œæ­£åœ¨åˆå§‹åŒ–...', 'error');
                    updateConfig();
                }
                
                log('å¼€å§‹æµ‹è¯•å åœåˆ†æ...', 'info');
                stats.total++;
            
            const testData = {
                birthDate: '1990-01-01',
                birthTime: '12:00',
                birthPlace: 'Beijing',
                gender: 'male',
                categories: ['career', 'wealth']
            };
            
            log(`æµ‹è¯•æ•°æ®: ${JSON.stringify(testData)}`, 'info');
            
                const startTime = Date.now();
                
                const result = await window.aiService.analyzeDivination(testData);
                const duration = Date.now() - startTime;
                stats.times.push(duration);
                stats.success++;
                
                log(`âœ… å åœåˆ†ææˆåŠŸï¼è€—æ—¶: ${duration}ms`, 'success');
                log(`ç»“æœé¢„è§ˆ:`, 'success');
                log(`- æ€§æ ¼ç‰¹ç‚¹: ${result.personality?.slice(0, 2).join(', ')}...`, 'success');
                log(`- äº”è¡Œ: æœ¨${result.elements?.wood} ç«${result.elements?.fire} åœŸ${result.elements?.earth} é‡‘${result.elements?.metal} æ°´${result.elements?.water}`, 'success');
                log(`å®Œæ•´ç»“æœ: ${JSON.stringify(result, null, 2)}`, 'info');
            } catch (error) {
                stats.failed++;
                log(`âŒ å åœåˆ†æå¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
            }
            
            updateStats();
        }
        
        async function testFengShui() {
            try {
                // æ£€æŸ¥ aiService æ˜¯å¦å­˜åœ¨
                if (!window.aiService) {
                    log('âŒ AI æœåŠ¡æœªåˆå§‹åŒ–ï¼Œæ­£åœ¨åˆå§‹åŒ–...', 'error');
                    updateConfig();
                }
                
                log('å¼€å§‹æµ‹è¯•é£æ°´åˆ†æ...', 'info');
                stats.total++;
            
            const testData = {
                direction: 45,
                spaceType: 'å±…ä½ç©ºé—´',
                concerns: 'æ•´ä½“è¿åŠ¿'
            };
            
            log(`æµ‹è¯•æ•°æ®: ${JSON.stringify(testData)}`, 'info');
            
                const startTime = Date.now();
                
                const result = await window.aiService.analyzeFengShui(testData);
                const duration = Date.now() - startTime;
                stats.times.push(duration);
                stats.success++;
                
                log(`âœ… é£æ°´åˆ†ææˆåŠŸï¼è€—æ—¶: ${duration}ms`, 'success');
                log(`ç»“æœé¢„è§ˆ:`, 'success');
                log(`- æ•´ä½“è¯„åˆ†: ${result.overallScore}`, 'success');
                log(`- æ–¹ä½åˆ†æ: ${result.directionAnalysis?.substring(0, 50)}...`, 'success');
                log(`- å»ºè®®æ•°é‡: ${result.recommendations?.length}`, 'success');
                log(`å®Œæ•´ç»“æœ: ${JSON.stringify(result, null, 2)}`, 'info');
            } catch (error) {
                stats.failed++;
                log(`âŒ é£æ°´åˆ†æå¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
            }
            
            updateStats();
        }
        
        async function testIChing() {
            try {
                // æ£€æŸ¥ aiService æ˜¯å¦å­˜åœ¨
                if (!window.aiService) {
                    log('âŒ AI æœåŠ¡æœªåˆå§‹åŒ–ï¼Œæ­£åœ¨åˆå§‹åŒ–...', 'error');
                    updateConfig();
                }
                
                log('å¼€å§‹æµ‹è¯•æ˜“ç»å åœ...', 'info');
                stats.total++;
            
            const testData = {
                question: 'æˆ‘çš„äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ',
                hexagram: 'ä¹¾ä¸ºå¤©',
                hexagramNumber: 1,
                changingLines: [3, 5]
            };
            
            log(`æµ‹è¯•æ•°æ®: ${JSON.stringify(testData)}`, 'info');
            
                const startTime = Date.now();
                
                const result = await window.aiService.analyzeIChing(testData);
                const duration = Date.now() - startTime;
                stats.times.push(duration);
                stats.success++;
                
                log(`âœ… æ˜“ç»å åœæˆåŠŸï¼è€—æ—¶: ${duration}ms`, 'success');
                log(`ç»“æœé¢„è§ˆ:`, 'success');
                log(`- å¦å: ${result.hexagramName}`, 'success');
                log(`- å¦è¾: ${result.judgment?.substring(0, 50)}...`, 'success');
                log(`- å»ºè®®: ${result.advice?.substring(0, 50)}...`, 'success');
                log(`å®Œæ•´ç»“æœ: ${JSON.stringify(result, null, 2)}`, 'info');
            } catch (error) {
                stats.failed++;
                log(`âŒ æ˜“ç»å åœå¤±è´¥: ${error.message}`, 'error');
                console.error('è¯¦ç»†é”™è¯¯:', error);
            }
            
            updateStats();
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="log-entry info">æ—¥å¿—å·²æ¸…ç©º</div>';
            stats = { total: 0, success: 0, failed: 0, times: [] };
            updateStats();
        }
        
        function exportLogs() {
            const logs = document.getElementById('logs').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `api-test-logs-${Date.now()}.txt`;
            a.click();
            log('æ—¥å¿—å·²å¯¼å‡º', 'success');
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            log('API æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success');
            log('è¯·é…ç½® API Key åå¼€å§‹æµ‹è¯•', 'info');
            
            // æ£€æŸ¥ CONFIG æ˜¯å¦åŠ è½½
            if (typeof CONFIG === 'undefined') {
                log('âŒ é”™è¯¯ï¼šconfig.js æœªåŠ è½½', 'error');
                return;
            }
            
            // ä» config.js åŠ è½½é»˜è®¤é…ç½®
            if (CONFIG.OPENROUTER_API_KEY && CONFIG.OPENROUTER_API_KEY !== 'YOUR_OPENROUTER_API_KEY_HERE') {
                document.getElementById('apiKey').value = CONFIG.OPENROUTER_API_KEY;
                log('å·²åŠ è½½é…ç½®æ–‡ä»¶ä¸­çš„ API Key', 'success');
            }
            
            document.getElementById('model').value = CONFIG.AI_MODEL;
            document.getElementById('mockMode').checked = CONFIG.FEATURES.MOCK_MODE;
            
            if (CONFIG.FEATURES.MOCK_MODE) {
                log('âš ï¸ å½“å‰å¤„äºæ¨¡æ‹Ÿæ¨¡å¼ï¼Œä¸ä¼šæ¶ˆè€— API é¢åº¦', 'info');
            }
            
            // åˆå§‹åŒ– aiService
            try {
                window.aiService = new AIService();
                log('âœ… AI æœåŠ¡å·²åˆå§‹åŒ–', 'success');
            } catch (error) {
                log(`âŒ AI æœåŠ¡åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>
