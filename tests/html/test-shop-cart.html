<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†åº—è´­ç‰©è½¦æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">ğŸ›’ å•†åº—è´­ç‰©è½¦åŠŸèƒ½æµ‹è¯•</h1>

        <!-- æµ‹è¯•çŠ¶æ€ -->
        <div id="testStatus" class="mb-6 p-4 rounded-lg bg-blue-900/50">
            <h2 class="text-xl font-bold mb-2">æµ‹è¯•çŠ¶æ€</h2>
            <div id="statusList" class="space-y-2 text-sm"></div>
        </div>

        <!-- ç”¨æˆ·ç™»å½•çŠ¶æ€ -->
        <div class="mb-6 p-4 rounded-lg bg-gray-800">
            <h2 class="text-xl font-bold mb-2">ç”¨æˆ·çŠ¶æ€</h2>
            <div id="userStatus" class="text-sm">æ£€æŸ¥ä¸­...</div>
            <button id="loginTestBtn" class="mt-2 bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">
                æµ‹è¯•ç™»å½•
            </button>
        </div>

        <!-- å•†å“åˆ—è¡¨ -->
        <div class="mb-6 p-4 rounded-lg bg-gray-800">
            <h2 class="text-xl font-bold mb-4">å•†å“åˆ—è¡¨</h2>
            <div id="productsList" class="space-y-2"></div>
        </div>

        <!-- è´­ç‰©è½¦ -->
        <div class="mb-6 p-4 rounded-lg bg-gray-800">
            <h2 class="text-xl font-bold mb-4">è´­ç‰©è½¦å†…å®¹</h2>
            <div id="cartContent" class="space-y-2"></div>
            <button id="refreshCartBtn" class="mt-4 bg-green-600 px-4 py-2 rounded hover:bg-green-700">
                åˆ·æ–°è´­ç‰©è½¦
            </button>
        </div>

        <!-- æµ‹è¯•æŒ‰é’® -->
        <div class="grid grid-cols-2 gap-4">
            <button id="testAddToCart" class="bg-yellow-600 px-6 py-3 rounded-lg hover:bg-yellow-700">
                æµ‹è¯•åŠ å…¥è´­ç‰©è½¦
            </button>
            <button id="testGetProducts" class="bg-purple-600 px-6 py-3 rounded-lg hover:bg-purple-700">
                æµ‹è¯•è·å–å•†å“
            </button>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="supabase-init.js"></script>
    <script src="shop-service.js"></script>

    <script>
        // æµ‹è¯•æ—¥å¿—
        function addLog(message, type = 'info') {
            const statusList = document.getElementById('statusList');
            const colors = {
                success: 'text-green-400',
                error: 'text-red-400',
                info: 'text-blue-400',
                warning: 'text-yellow-400'
            };
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸',
                warning: 'âš ï¸'
            };
            const log = document.createElement('div');
            log.className = colors[type];
            log.textContent = `${icons[type]} ${new Date().toLocaleTimeString()} - ${message}`;
            statusList.appendChild(log);
            console.log(message);
        }

        // ç­‰å¾…åˆå§‹åŒ–
        async function waitForInit() {
            let attempts = 0;
            while (!window.supabaseClient && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            if (!window.supabaseClient) {
                throw new Error('Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–è¶…æ—¶');
            }
        }

        // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        async function checkUserStatus() {
            try {
                await waitForInit();
                const user = await window.EnhancedAuthService.getCurrentUser();
                const userStatus = document.getElementById('userStatus');
                
                if (user) {
                    userStatus.innerHTML = `
                        <div class="text-green-400">âœ… å·²ç™»å½•</div>
                        <div>é‚®ç®±: ${user.email}</div>
                        <div>ID: ${user.id}</div>
                    `;
                    addLog('ç”¨æˆ·å·²ç™»å½•: ' + user.email, 'success');
                    return user;
                } else {
                    userStatus.innerHTML = '<div class="text-red-400">âŒ æœªç™»å½•</div>';
                    addLog('ç”¨æˆ·æœªç™»å½•', 'warning');
                    return null;
                }
            } catch (error) {
                addLog('æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å¤±è´¥: ' + error.message, 'error');
                return null;
            }
        }

        // æµ‹è¯•è·å–å•†å“
        async function testGetProducts() {
            try {
                addLog('å¼€å§‹è·å–å•†å“åˆ—è¡¨...', 'info');
                const result = await window.ShopService.products.getAll();
                
                if (result.success) {
                    addLog(`æˆåŠŸè·å– ${result.data.length} ä¸ªå•†å“`, 'success');
                    displayProducts(result.data);
                } else {
                    addLog('è·å–å•†å“å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                addLog('è·å–å•†å“å¼‚å¸¸: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºå•†å“
        function displayProducts(products) {
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = products.map(p => `
                <div class="flex items-center justify-between bg-gray-700 p-3 rounded">
                    <div>
                        <span class="font-bold">${p.name_en || p.name}</span>
                        <span class="text-gray-400 ml-2">$${p.price}</span>
                        <span class="text-gray-500 ml-2">åº“å­˜: ${p.stock}</span>
                    </div>
                    <button onclick="testAddProduct('${p.id}')" 
                            class="bg-green-600 px-3 py-1 rounded text-sm hover:bg-green-700">
                        åŠ å…¥è´­ç‰©è½¦
                    </button>
                </div>
            `).join('');
        }

        // æµ‹è¯•åŠ å…¥è´­ç‰©è½¦
        window.testAddProduct = async function(productId) {
            try {
                addLog(`å°è¯•æ·»åŠ å•†å“ ${productId} åˆ°è´­ç‰©è½¦...`, 'info');
                const result = await window.ShopService.cart.add(productId, 1);
                
                if (result.success) {
                    addLog('æˆåŠŸæ·»åŠ åˆ°è´­ç‰©è½¦', 'success');
                    await refreshCart();
                } else {
                    addLog('æ·»åŠ å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                addLog('æ·»åŠ å¼‚å¸¸: ' + error.message, 'error');
            }
        };

        // åˆ·æ–°è´­ç‰©è½¦
        async function refreshCart() {
            try {
                addLog('åˆ·æ–°è´­ç‰©è½¦...', 'info');
                const result = await window.ShopService.cart.get();
                
                if (result.success) {
                    const cartContent = document.getElementById('cartContent');
                    if (result.data && result.data.length > 0) {
                        addLog(`è´­ç‰©è½¦æœ‰ ${result.data.length} ä¸ªå•†å“`, 'success');
                        cartContent.innerHTML = result.data.map(item => `
                            <div class="bg-gray-700 p-3 rounded">
                                <div class="font-bold">${item.products.name_en || item.products.name}</div>
                                <div class="text-sm text-gray-400">
                                    æ•°é‡: ${item.quantity} Ã— $${item.products.price} = $${(item.quantity * item.products.price).toFixed(2)}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        cartContent.innerHTML = '<div class="text-gray-400">è´­ç‰©è½¦æ˜¯ç©ºçš„</div>';
                        addLog('è´­ç‰©è½¦ä¸ºç©º', 'info');
                    }
                } else {
                    addLog('è·å–è´­ç‰©è½¦å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                addLog('åˆ·æ–°è´­ç‰©è½¦å¼‚å¸¸: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•ç™»å½•
        document.getElementById('loginTestBtn').addEventListener('click', async () => {
            const email = prompt('è¯·è¾“å…¥é‚®ç®±:');
            const password = prompt('è¯·è¾“å…¥å¯†ç :');
            
            if (email && password) {
                try {
                    addLog('å°è¯•ç™»å½•...', 'info');
                    const result = await window.EnhancedAuthService.login(email, password);
                    if (result.success) {
                        addLog('ç™»å½•æˆåŠŸ', 'success');
                        await checkUserStatus();
                    } else {
                        addLog('ç™»å½•å¤±è´¥: ' + result.error, 'error');
                    }
                } catch (error) {
                    addLog('ç™»å½•å¼‚å¸¸: ' + error.message, 'error');
                }
            }
        });

        // ç»‘å®šæµ‹è¯•æŒ‰é’®
        document.getElementById('testGetProducts').addEventListener('click', testGetProducts);
        document.getElementById('testAddToCart').addEventListener('click', async () => {
            // æ·»åŠ ç¬¬ä¸€ä¸ªå•†å“
            await testAddProduct('dragon');
        });
        document.getElementById('refreshCartBtn').addEventListener('click', refreshCart);

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            addLog('é¡µé¢åŠ è½½å®Œæˆ', 'info');
            
            try {
                await waitForInit();
                addLog('Supabase åˆå§‹åŒ–å®Œæˆ', 'success');
                
                // æ£€æŸ¥æœåŠ¡
                if (window.ShopService) {
                    addLog('ShopService å·²åŠ è½½', 'success');
                } else {
                    addLog('ShopService æœªåŠ è½½', 'error');
                }
                
                if (window.EnhancedAuthService) {
                    addLog('EnhancedAuthService å·²åŠ è½½', 'success');
                } else {
                    addLog('EnhancedAuthService æœªåŠ è½½', 'error');
                }
                
                // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
                await checkUserStatus();
                
                // è‡ªåŠ¨è·å–å•†å“
                await testGetProducts();
                
                // è‡ªåŠ¨åˆ·æ–°è´­ç‰©è½¦
                await refreshCart();
                
            } catch (error) {
                addLog('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
