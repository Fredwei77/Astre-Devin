<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase è¿æ¥æµ‹è¯• - Destiny AI</title>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #0d2626 0%, #1a3a3a 100%);
            min-height: 100vh;
        }
        .test-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        .info { color: #60a5fa; }
    </style>
</head>
<body class="text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-bold mb-8 text-center" style="color: #ffd700;">
            ğŸ”® Supabase è¿æ¥æµ‹è¯•
        </h1>

        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="test-card rounded-xl p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">è¿æ¥çŠ¶æ€</h2>
            <div id="connectionStatus" class="text-lg">
                <span class="info">â³ æ­£åœ¨åˆå§‹åŒ–...</span>
            </div>
        </div>

        <!-- è®¤è¯æµ‹è¯• -->
        <div class="test-card rounded-xl p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">è®¤è¯æµ‹è¯•</h2>
            
            <!-- æ³¨å†Œæµ‹è¯• -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-3">1. ç”¨æˆ·æ³¨å†Œ</h3>
                <div class="flex gap-2 mb-2">
                    <input type="email" id="registerEmail" placeholder="é‚®ç®±" 
                        class="flex-1 bg-white/10 border border-white/30 rounded px-4 py-2">
                    <input type="password" id="registerPassword" placeholder="å¯†ç " 
                        class="flex-1 bg-white/10 border border-white/30 rounded px-4 py-2">
                    <button onclick="testRegister()" 
                        class="bg-yellow-500 text-black px-6 py-2 rounded font-semibold hover:bg-yellow-400">
                        æ³¨å†Œ
                    </button>
                </div>
                <div id="registerResult" class="text-sm mt-2"></div>
            </div>

            <!-- ç™»å½•æµ‹è¯• -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-3">2. ç”¨æˆ·ç™»å½•</h3>
                <div class="flex gap-2 mb-2">
                    <input type="email" id="loginEmail" placeholder="é‚®ç®±" 
                        class="flex-1 bg-white/10 border border-white/30 rounded px-4 py-2">
                    <input type="password" id="loginPassword" placeholder="å¯†ç " 
                        class="flex-1 bg-white/10 border border-white/30 rounded px-4 py-2">
                    <button onclick="testLogin()" 
                        class="bg-yellow-500 text-black px-6 py-2 rounded font-semibold hover:bg-yellow-400">
                        ç™»å½•
                    </button>
                </div>
                <div id="loginResult" class="text-sm mt-2"></div>
            </div>

            <!-- å½“å‰ç”¨æˆ· -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-3">3. å½“å‰ç”¨æˆ·</h3>
                <button onclick="testGetUser()" 
                    class="bg-blue-500 text-white px-6 py-2 rounded font-semibold hover:bg-blue-400">
                    è·å–å½“å‰ç”¨æˆ·
                </button>
                <div id="userResult" class="text-sm mt-2"></div>
            </div>

            <!-- ç™»å‡ºæµ‹è¯• -->
            <div>
                <h3 class="text-xl font-semibold mb-3">4. ç”¨æˆ·ç™»å‡º</h3>
                <button onclick="testLogout()" 
                    class="bg-red-500 text-white px-6 py-2 rounded font-semibold hover:bg-red-400">
                    ç™»å‡º
                </button>
                <div id="logoutResult" class="text-sm mt-2"></div>
            </div>
        </div>

        <!-- æ•°æ®åº“æµ‹è¯• -->
        <div class="test-card rounded-xl p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">æ•°æ®åº“æµ‹è¯•</h2>
            
            <!-- ä¿å­˜å åœè®°å½• -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-3">5. ä¿å­˜å åœè®°å½•</h3>
                <button onclick="testSaveReading()" 
                    class="bg-green-500 text-white px-6 py-2 rounded font-semibold hover:bg-green-400">
                    ä¿å­˜æµ‹è¯•è®°å½•
                </button>
                <div id="saveResult" class="text-sm mt-2"></div>
            </div>

            <!-- è·å–å åœè®°å½• -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-3">6. è·å–å åœè®°å½•</h3>
                <button onclick="testGetReadings()" 
                    class="bg-purple-500 text-white px-6 py-2 rounded font-semibold hover:bg-purple-400">
                    è·å–æˆ‘çš„è®°å½•
                </button>
                <div id="readingsResult" class="text-sm mt-2"></div>
            </div>

            <!-- è®°å½•ä½¿ç”¨ -->
            <div>
                <h3 class="text-xl font-semibold mb-3">7. è®°å½•ä½¿ç”¨æ¬¡æ•°</h3>
                <button onclick="testRecordUsage()" 
                    class="bg-indigo-500 text-white px-6 py-2 rounded font-semibold hover:bg-indigo-400">
                    è®°å½•ä½¿ç”¨
                </button>
                <div id="usageResult" class="text-sm mt-2"></div>
            </div>
        </div>

        <!-- è¿”å›é¦–é¡µ -->
        <div class="text-center">
            <a href="index.html" class="inline-block bg-yellow-500 text-black px-8 py-3 rounded-lg font-semibold hover:bg-yellow-400">
                è¿”å›é¦–é¡µ
            </a>
        </div>
    </div>

    <!-- Supabase Integration -->
    <script src="supabase-client.js"></script>
    <script src="supabase-init.js"></script>

    <script>
        // ç­‰å¾…Supabaseåˆå§‹åŒ–
        setTimeout(() => {
            checkConnection();
        }, 1000);

        function checkConnection() {
            const status = document.getElementById('connectionStatus');
            if (window.supabaseClient) {
                status.innerHTML = '<span class="success">âœ… Supabaseå®¢æˆ·ç«¯å·²è¿æ¥</span>';
            } else {
                status.innerHTML = '<span class="error">âŒ Supabaseå®¢æˆ·ç«¯æœªåˆå§‹åŒ–</span>';
            }
        }

        async function testRegister() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const result = document.getElementById('registerResult');

            if (!email || !password) {
                result.innerHTML = '<span class="error">âŒ è¯·å¡«å†™é‚®ç®±å’Œå¯†ç </span>';
                return;
            }

            result.innerHTML = '<span class="info">â³ æ³¨å†Œä¸­...</span>';

            const res = await EnhancedAuthService.register(email, password);
            
            if (res.success) {
                result.innerHTML = `<span class="success">âœ… æ³¨å†ŒæˆåŠŸï¼ç”¨æˆ·ID: ${res.user.id}</span>`;
            } else {
                result.innerHTML = `<span class="error">âŒ æ³¨å†Œå¤±è´¥: ${res.error}</span>`;
            }
        }

        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const result = document.getElementById('loginResult');

            if (!email || !password) {
                result.innerHTML = '<span class="error">âŒ è¯·å¡«å†™é‚®ç®±å’Œå¯†ç </span>';
                return;
            }

            result.innerHTML = '<span class="info">â³ ç™»å½•ä¸­...</span>';

            const res = await EnhancedAuthService.login(email, password);
            
            if (res.success) {
                result.innerHTML = `<span class="success">âœ… ç™»å½•æˆåŠŸï¼é‚®ç®±: ${res.user.email}</span>`;
            } else {
                result.innerHTML = `<span class="error">âŒ ç™»å½•å¤±è´¥: ${res.error}</span>`;
            }
        }

        async function testGetUser() {
            const result = document.getElementById('userResult');
            result.innerHTML = '<span class="info">â³ è·å–ä¸­...</span>';

            const user = await EnhancedAuthService.getCurrentUser();
            
            if (user) {
                result.innerHTML = `<span class="success">âœ… å½“å‰ç”¨æˆ·: ${user.email}<br>ID: ${user.id}</span>`;
            } else {
                result.innerHTML = '<span class="error">âŒ æœªç™»å½•</span>';
            }
        }

        async function testLogout() {
            const result = document.getElementById('logoutResult');
            result.innerHTML = '<span class="info">â³ ç™»å‡ºä¸­...</span>';

            const res = await EnhancedAuthService.logout();
            
            if (res.success) {
                result.innerHTML = '<span class="success">âœ… ç™»å‡ºæˆåŠŸ</span>';
            } else {
                result.innerHTML = `<span class="error">âŒ ç™»å‡ºå¤±è´¥: ${res.error}</span>`;
            }
        }

        async function testSaveReading() {
            const result = document.getElementById('saveResult');
            result.innerHTML = '<span class="info">â³ ä¿å­˜ä¸­...</span>';

            const res = await DatabaseService.saveReading(
                'divination',
                { birthDate: '1990-01-01', category: 'career' },
                { personality: ['æµ‹è¯•æ•°æ®'], career: ['æµ‹è¯•æ•°æ®'] }
            );
            
            if (res.success) {
                result.innerHTML = `<span class="success">âœ… ä¿å­˜æˆåŠŸï¼è®°å½•ID: ${res.data.id}</span>`;
            } else {
                result.innerHTML = `<span class="error">âŒ ä¿å­˜å¤±è´¥: ${res.error}</span>`;
            }
        }

        async function testGetReadings() {
            const result = document.getElementById('readingsResult');
            result.innerHTML = '<span class="info">â³ è·å–ä¸­...</span>';

            const res = await DatabaseService.getUserReadings(5);
            
            if (res.success) {
                if (res.data.length > 0) {
                    const list = res.data.map(r => 
                        `<div class="bg-white/5 p-2 rounded mt-1">
                            ${r.type} - ${new Date(r.created_at).toLocaleString()}
                        </div>`
                    ).join('');
                    result.innerHTML = `<span class="success">âœ… æ‰¾åˆ° ${res.data.length} æ¡è®°å½•</span>${list}`;
                } else {
                    result.innerHTML = '<span class="info">â„¹ï¸ æš‚æ— è®°å½•</span>';
                }
            } else {
                result.innerHTML = `<span class="error">âŒ è·å–å¤±è´¥: ${res.error}</span>`;
            }
        }

        async function testRecordUsage() {
            const result = document.getElementById('usageResult');
            result.innerHTML = '<span class="info">â³ è®°å½•ä¸­...</span>';

            const res = await DatabaseService.recordUsage('divination', { test: true });
            
            if (res.success) {
                result.innerHTML = '<span class="success">âœ… ä½¿ç”¨è®°å½•å·²ä¿å­˜</span>';
            } else {
                result.innerHTML = `<span class="error">âŒ è®°å½•å¤±è´¥: ${res.error}</span>`;
            }
        }
    </script>
</body>
</html>
