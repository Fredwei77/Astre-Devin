# 用户菜单集成指南

## 📋 概述

用户菜单系统提供了完整的用户下拉菜单功能，包括：
- 👤 用户信息显示
- 👑 会员升级入口
- 🚪 退出登录功能
- 📊 个人数据访问

## ✅ 已完成的工作

### 1. 核心文件创建

- ✅ `user-menu.js` - 用户菜单管理脚本
- ✅ `user-menu.css` - 用户菜单样式
- ✅ `auth-service.js` - 认证服务（已存在）

### 2. 已更新的页面

- ✅ `index.html` - 首页导航栏

## 🚀 快速集成

### 步骤1：添加CSS

在页面的 `<head>` 部分添加：

```html
<!-- User Menu Styles -->
<link rel="stylesheet" href="user-menu.css">
```

### 步骤2：添加HTML结构

在导航栏中添加以下结构：

```html
<!-- Login/User Section -->
<div id="authSection" class="flex items-center space-x-3">
    <!-- Guest View (Not Logged In) -->
    <div id="guestView" class="flex items-center space-x-3">
        <button id="loginBtn" 
            class="text-moon-silver hover:text-mystic-gold transition-colors font-medium flex items-center gap-2">
            <i class="fas fa-sign-in-alt"></i>
            <span data-i18n="nav.login">登入</span>
        </button>
        <a href="payment.html"
            class="bg-mystic-gold text-deep-navy px-4 py-2 rounded-lg font-medium hover:bg-yellow-400 transition-colors"
            data-i18n="nav.getStarted">
            开始使用
        </a>
    </div>
    
    <!-- User View (Logged In) -->
    <div id="userView" class="hidden">
        <div class="flex items-center space-x-3">
            <!-- User Avatar and Name -->
            <div class="flex items-center space-x-2 user-avatar-container">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-mystic-gold to-moon-silver flex items-center justify-center border-2 border-mystic-gold/50 shadow-lg">
                    <img id="userAvatar" src="" alt="User Avatar" class="w-full h-full rounded-full object-cover hidden">
                    <i id="userIcon" class="fas fa-user text-deep-navy text-sm"></i>
                </div>
                <div class="flex flex-col">
                    <span id="userName" class="text-moon-silver font-medium text-sm"></span>
                    <span id="userLevel" class="text-mystic-gold text-xs hidden">VIP</span>
                </div>
            </div>
            
            <!-- Dropdown Menu Button -->
            <div class="relative">
                <button id="userMenuBtn" class="text-moon-silver hover:text-mystic-gold transition-all duration-300 p-2 hover:bg-mystic-gold/10 rounded-full">
                    <i class="fas fa-chevron-down text-sm"></i>
                </button>
                
                <!-- Dropdown Menu -->
                <div id="userMenu" class="absolute right-0 mt-2 w-56 bg-black/95 backdrop-blur-md border-2 border-mystic-gold/30 rounded-xl shadow-2xl hidden z-50 overflow-hidden">
                    <!-- User Info Card -->
                    <div class="user-info-card">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-mystic-gold to-moon-silver flex items-center justify-center border-2 border-mystic-gold/50">
                                <i class="fas fa-user text-deep-navy"></i>
                            </div>
                            <div class="flex-1">
                                <div id="menuUserName" class="text-warm-white font-semibold text-sm"></div>
                                <div id="menuUserEmail" class="user-email"></div>
                                <div id="menuUserStatus" class="user-status">免费会员</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Menu Items -->
                    <div class="py-2">
                        <a href="profile.html" class="flex items-center px-4 py-3 text-moon-silver hover:text-mystic-gold hover:bg-mystic-gold/10 transition-all">
                            <i class="fas fa-user-circle w-5"></i>
                            <span class="ml-3" data-i18n="nav.userInfo">个人信息</span>
                        </a>
                        
                        <a href="profile.html#readings" class="flex items-center px-4 py-3 text-moon-silver hover:text-mystic-gold hover:bg-mystic-gold/10 transition-all">
                            <i class="fas fa-history w-5"></i>
                            <span class="ml-3" data-i18n="nav.myReadings">我的占卜</span>
                        </a>
                        
                        <a href="payment.html" class="flex items-center px-4 py-3 text-moon-silver hover:text-mystic-gold hover:bg-mystic-gold/10 transition-all">
                            <i class="fas fa-crown w-5"></i>
                            <span class="ml-3" data-i18n="nav.upgrade">会员升级</span>
                            <span class="ml-auto text-xs bg-mystic-gold text-deep-navy px-2 py-1 rounded-full font-bold">HOT</span>
                        </a>
                        
                        <a href="profile.html#settings" class="flex items-center px-4 py-3 text-moon-silver hover:text-mystic-gold hover:bg-mystic-gold/10 transition-all">
                            <i class="fas fa-cog w-5"></i>
                            <span class="ml-3" data-i18n="nav.settings">设置</span>
                        </a>
                    </div>
                    
                    <hr class="border-mystic-gold/20 mx-3">
                    
                    <!-- Logout Button -->
                    <div class="py-2">
                        <button id="logoutBtn" class="w-full flex items-center px-4 py-3 text-moon-silver hover:text-red-400 hover:bg-red-400/10 transition-all">
                            <i class="fas fa-sign-out-alt w-5"></i>
                            <span class="ml-3" data-i18n="nav.logout">退出登录</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
```

### 步骤3：添加JavaScript

在页面的 `</body>` 标签前添加：

```html
<!-- 认证系统 -->
<script src="auth-service.js"></script>

<!-- 用户菜单系统 -->
<script src="user-menu.js"></script>
```

## 🎨 功能特性

### 1. 自动状态管理

- ✅ 自动检测登录状态
- ✅ 未登录显示"登入"按钮
- ✅ 已登录显示用户信息和下拉菜单

### 2. 用户信息显示

- ✅ 用户头像（支持自定义头像）
- ✅ 用户名称（自动从邮箱提取）
- ✅ 会员等级（VIP标识）

### 3. 下拉菜单功能

- ✅ 个人信息 - 跳转到个人档案页
- ✅ 我的占卜 - 查看历史记录
- ✅ 会员升级 - 跳转到支付页面
- ✅ 设置 - 个人设置
- ✅ 退出登录 - 安全登出

### 4. 交互效果

- ✅ 平滑的下拉动画
- ✅ 悬停高亮效果
- ✅ 点击外部自动关闭
- ✅ ESC键关闭菜单

## 💻 API使用

### 手动更新用户信息

```javascript
// 获取用户菜单管理器实例
const userMenu = window.UserMenuManager;

// 手动更新UI
userMenu.updateUI();

// 打开菜单
userMenu.openMenu();

// 关闭菜单
userMenu.closeMenu();
```

### 监听事件

```javascript
// 监听认证状态变化
window.addEventListener('authStateChanged', (e) => {
    const { isAuthenticated, user } = e.detail;
    console.log('认证状态变化:', isAuthenticated);
});
```

## 🔧 自定义配置

### 修改菜单项

编辑 HTML 中的菜单项部分，添加或删除菜单项：

```html
<a href="your-page.html" class="flex items-center px-4 py-3 text-moon-silver hover:text-mystic-gold hover:bg-mystic-gold/10 transition-all">
    <i class="fas fa-your-icon w-5"></i>
    <span class="ml-3">你的菜单项</span>
</a>
```

### 修改样式

编辑 `user-menu.css` 文件来自定义样式：

```css
/* 修改菜单宽度 */
#userMenu {
    min-width: 250px;
}

/* 修改菜单背景 */
#userMenu {
    background: rgba(0, 0, 0, 0.98);
}
```

## 🧪 测试

### 测试未登录状态

1. 清除浏览器存储
2. 刷新页面
3. 应显示"登入"按钮

### 测试已登录状态

1. 打开 `test-access-control.html`
2. 点击"模拟登录"
3. 返回页面
4. 应显示用户信息和下拉菜单

### 测试下拉菜单

1. 点击用户名旁的下拉箭头
2. 菜单应平滑展开
3. 点击菜单外部
4. 菜单应自动关闭

### 测试退出登录

1. 点击"退出登录"
2. 应显示确认对话框
3. 确认后应清除登录状态
4. 页面应刷新并显示"登入"按钮

## 📋 集成清单

### 需要集成的页面

- [x] index.html - 首页
- [ ] divination.html - 占卜页
- [ ] fengshui.html - 风水页
- [ ] iching.html - 易经页
- [ ] profile.html - 个人档案页
- [ ] payment.html - 支付页

### 集成步骤

对于每个页面：

1. [ ] 添加 `user-menu.css` 引用
2. [ ] 添加用户菜单HTML结构
3. [ ] 添加 `auth-service.js` 引用
4. [ ] 添加 `user-menu.js` 引用
5. [ ] 测试功能是否正常

## 🐛 故障排除

### 问题1：菜单不显示

**解决方法**：
1. 检查是否引入了 `user-menu.css`
2. 检查是否引入了 `user-menu.js`
3. 查看浏览器控制台错误

### 问题2：用户信息不更新

**解决方法**：
1. 确认 `auth-service.js` 已加载
2. 检查localStorage中的用户数据
3. 手动调用 `UserMenuManager.updateUI()`

### 问题3：点击菜单没反应

**解决方法**：
1. 检查元素ID是否正确
2. 查看控制台JavaScript错误
3. 确认事件绑定是否成功

## 📚 相关文档

- `auth-service.js` - 认证服务文档
- `访问控制系统设计.md` - 访问控制系统
- `user-menu.js` - 用户菜单源码

## 🎉 完成标志

系统集成成功的标志：

1. ✅ 未登录显示"登入"按钮
2. ✅ 已登录显示用户信息
3. ✅ 点击下拉箭头展开菜单
4. ✅ 菜单项可以正常点击
5. ✅ 退出登录功能正常
6. ✅ 无JavaScript错误

---

**集成完成后，请测试所有功能！** 🚀
