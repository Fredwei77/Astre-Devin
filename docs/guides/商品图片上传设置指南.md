# 📸 商品图片上传功能设置指南

## 功能说明

管理后台现在支持两种方式添加商品图片：
1. **上传本地图片** - 上传到 Supabase Storage
2. **输入图片URL** - 使用外部图片链接

## 🚀 Supabase Storage 设置

### 步骤 1: 创建 Storage Bucket

1. 登录 [Supabase Dashboard](https://app.supabase.com)
2. 选择你的项目
3. 点击左侧菜单 "Storage"
4. 点击 "Create a new bucket"
5. 填写信息：
   - **Name**: `product-images`
   - **Public bucket**: ✅ 勾选（允许公开访问）
   - **File size limit**: 5MB（可选）
   - **Allowed MIME types**: `image/*`（可选）
6. 点击 "Create bucket"

### 步骤 2: 设置 Storage 策略

在 SQL Editor 中执行以下 SQL：

```sql
-- 允许所有人查看图片
CREATE POLICY "Public Access"
ON storage.objects FOR SELECT
USING ( bucket_id = 'product-images' );

-- 允许认证用户上传图片
CREATE POLICY "Authenticated users can upload"
ON storage.objects FOR INSERT
WITH CHECK (
    bucket_id = 'product-images' 
    AND auth.role() = 'authenticated'
);

-- 允许认证用户删除自己上传的图片
CREATE POLICY "Users can delete own uploads"
ON storage.objects FOR DELETE
USING (
    bucket_id = 'product-images' 
    AND auth.role() = 'authenticated'
);
```

### 步骤 3: 验证设置

1. 访问管理后台: http://localhost:8000/admin-shop.html
2. 尝试上传一张图片
3. 检查 Supabase Dashboard → Storage → product-images
4. 应该看到上传的图片

## 📝 使用方法

### 方式 1: 上传本地图片

1. 在管理后台填写商品信息
2. 点击"商品图片"下的文件选择按钮
3. 选择本地图片文件（支持 JPG, PNG, GIF, WebP）
4. 图片会自动预览
5. 点击"保存商品"
6. 图片会自动上传到 Supabase Storage

### 方式 2: 使用图片URL

1. 在管理后台填写商品信息
2. 在"或输入图片URL"输入框中粘贴图片链接
3. 图片会自动预览
4. 点击"保存商品"
5. URL会保存到数据库

## 🎨 图片要求

### 推荐规格
- **尺寸**: 800x800 像素（正方形）
- **格式**: JPG, PNG, WebP
- **大小**: < 2MB
- **背景**: 白色或透明

### 最小要求
- **尺寸**: 400x400 像素
- **格式**: JPG, PNG, GIF, WebP
- **大小**: < 5MB

## 🔧 前端显示

### 商品列表
- 如果有图片URL，显示图片（80x80px）
- 如果没有图片，显示 Emoji 图标

### 商品卡片
- 图片会自动适配容器
- 使用 `object-cover` 保持比例

## 📊 数据库字段

商品表已包含 `image_url` 字段：

```sql
CREATE TABLE products (
    ...
    image_url TEXT,  -- 图片URL
    icon TEXT DEFAULT '🎁',  -- Emoji图标（备用）
    ...
);
```

## 🐛 故障排除

### 问题 1: 上传失败

**可能原因**:
- Storage bucket 未创建
- 权限策略未设置
- 用户未登录

**解决方法**:
1. 检查 Supabase Dashboard → Storage
2. 验证 bucket 名称是否为 `product-images`
3. 检查 Storage 策略
4. 确认用户已登录

### 问题 2: 图片不显示

**可能原因**:
- 图片URL无效
- Storage bucket 不是公开的
- 图片已被删除

**解决方法**:
1. 检查图片URL是否可访问
2. 验证 bucket 是否设置为 public
3. 在浏览器中直接访问图片URL

### 问题 3: 预览不显示

**可能原因**:
- 图片格式不支持
- 文件太大
- 浏览器限制

**解决方法**:
1. 使用标准图片格式（JPG, PNG）
2. 压缩图片大小
3. 检查浏览器控制台错误

## 💡 最佳实践

### 1. 图片优化
```bash
# 使用工具压缩图片
# 推荐: TinyPNG, ImageOptim, Squoosh
```

### 2. 命名规范
- 使用时间戳 + 随机字符串
- 避免中文文件名
- 示例: `1701234567-abc123.jpg`

### 3. 备份策略
- 定期备份 Storage
- 保留原始图片
- 使用 CDN 加速

### 4. 性能优化
- 使用 WebP 格式
- 启用图片懒加载
- 使用缩略图

## 🔐 安全建议

### 1. 文件类型验证
```javascript
// 只允许图片格式
accept="image/*"
```

### 2. 文件大小限制
```javascript
// 限制 5MB
if (file.size > 5 * 1024 * 1024) {
    alert('文件太大，请选择小于5MB的图片');
    return;
}
```

### 3. 权限控制
- 只有认证用户可以上传
- 使用 RLS 策略保护

## 📈 扩展功能

### 短期扩展
- [ ] 图片裁剪功能
- [ ] 多图片上传
- [ ] 图片编辑器
- [ ] 拖拽上传

### 中期扩展
- [ ] 图片CDN集成
- [ ] 自动生成缩略图
- [ ] 图片水印
- [ ] 批量上传

### 长期扩展
- [ ] AI图片优化
- [ ] 图片搜索
- [ ] 图片标签
- [ ] 图片版本管理

## 🎓 相关资源

- [Supabase Storage 文档](https://supabase.com/docs/guides/storage)
- [图片优化指南](https://web.dev/fast/#optimize-your-images)
- [WebP 格式介绍](https://developers.google.com/speed/webp)

## ✅ 测试清单

- [ ] Storage bucket 已创建
- [ ] 权限策略已设置
- [ ] 可以上传本地图片
- [ ] 可以使用图片URL
- [ ] 图片预览正常
- [ ] 商品列表显示图片
- [ ] 编辑时显示现有图片
- [ ] 图片URL保存到数据库

## 🎉 完成！

图片上传功能已经完全集成到管理后台。

现在你可以：
- ✅ 上传商品图片
- ✅ 使用外部图片链接
- ✅ 实时预览图片
- ✅ 在商品列表中查看图片

**开始上传你的商品图片吧！** 📸
