# 访问控制系统 - 快速参考

## 🚀 快速开始（5分钟）

### 1. 在受保护页面添加脚本（必须）

在 `divination.html`, `fengshui.html`, `iching.html`, `profile.html` 的 `</body>` 标签前添加：

```html
<!-- 认证系统 -->
<script src="auth-service.js"></script>
<script src="auth-guard-enhanced.js"></script>
</body>
</html>
```

### 2. 测试系统

打开 `test-auth-system.html` 进行测试。

## 📋 常用API

### 检查登录状态
```javascript
if (AuthService.isAuthenticated()) {
    console.log('用户已登录');
}
```

### 获取当前用户
```javascript
const user = AuthService.getCurrentUser();
console.log(user.email);
```

### 登录
```javascript
AuthService.setAuth(token, userData, rememberMe);
```

### 登出
```javascript
AuthService.logout();
```

### 要求登录后执行
```javascript
AuthGuard.requireAuth((user) => {
    // 用户已登录，执行操作
    console.log('用户:', user.email);
});
```

### 获取认证头部（API请求）
```javascript
fetch('/api/data', {
    headers: AuthService.getAuthHeader()
});
```

## 🎯 受保护的页面

- ✅ `divination.html` - AI占卜
- ✅ `fengshui.html` - 风水分析
- ✅ `iching.html` - 易经卦象
- ✅ `profile.html` - 个人档案

## 🌐 公开页面

- ✅ `index.html` - 首页
- ✅ `login.html` - 登录页
- ✅ `payment.html` - 支付页
- ✅ `terms.html` - 服务条款
- ✅ `privacy.html` - 隐私政策

## 🔧 配置选项

在 `auth-guard-enhanced.js` 中修改：

```javascript
const CONFIG = {
    loginPage: 'login.html',      // 登录页
    homePage: 'index.html',       // 首页
    enableLogging: true,          // 启用日志
    showPrompt: true,             // 显示提示框
    autoRedirect: false,          // 自动重定向
    redirectDelay: 3000           // 延迟（毫秒）
};
```

## 🧪 测试清单

- [ ] 未登录访问受保护页面 → 显示登录提示
- [ ] 登录后访问受保护页面 → 正常显示
- [ ] 登出后访问受保护页面 → 再次拦截
- [ ] 刷新页面 → 保持登录状态
- [ ] 多标签页同步 → 登出后其他标签同步

## 📞 故障排除

### 问题：登录后仍显示提示
**解决**：
1. 检查控制台错误
2. 验证localStorage中的数据
3. 确认脚本加载顺序

### 问题：无法重定向
**解决**：
1. 检查文件路径
2. 查看浏览器控制台
3. 验证CONFIG配置

### 问题：Token无效
**解决**：
1. 清除浏览器存储
2. 重新登录
3. 检查Token格式

## 📚 完整文档

- `页面访问控制系统设计.md` - 系统设计
- `访问控制集成指南.md` - 集成指南
- `test-auth-system.html` - 测试页面

## 🔐 安全提示

1. ⚠️ 生产环境必须使用 HTTPS
2. ⚠️ 后端必须验证Token
3. ⚠️ 定期刷新Token
4. ⚠️ 不要在localStorage存储敏感信息

## 💡 最佳实践

1. ✅ 使用 `auth-guard-enhanced.js`（推荐）
2. ✅ 启用日志便于调试
3. ✅ 定期备份文件
4. ✅ 测试所有场景
5. ✅ 监听认证状态变化

## 🎨 自定义样式

修改 `auth-guard-enhanced.js` 中的 `showLoginPrompt()` 函数来自定义登录提示的样式。

## 📊 监听事件

```javascript
// 监听认证状态变化
window.addEventListener('authStateChanged', (e) => {
    const { isAuthenticated, user } = e.detail;
    console.log('认证状态:', isAuthenticated);
});

// 监听页面访问检查
window.addEventListener('pageAccessChecked', (e) => {
    const { granted, user, page } = e.detail;
    console.log('页面访问:', granted);
});
```

## 🚀 下一步

1. 集成后端API验证
2. 实现Token刷新机制
3. 添加用户权限管理
4. 优化用户体验
5. 添加更多安全特性

---

**需要帮助？** 查看完整文档或打开 `test-auth-system.html` 进行测试。
