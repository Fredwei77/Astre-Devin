# 页面访问控制系统设计文档

## 系统概述

这是一个完整的前端页面访问控制系统，确保只有已登录用户才能访问受保护的页面（占卜、风水、易经、个人档案）。

## 核心组件

### 1. 认证守卫 (auth-guard.js)
- 页面加载时自动检查登录状态
- 拦截未授权访问
- 显示友好的登录提示
- 支持返回URL功能

### 2. 认证服务 (auth-service.js)
- 统一的认证状态管理
- Token验证和刷新
- 用户信息存储
- 登录/登出功能

### 3. 页面集成
- 所有受保护页面引入守卫脚本
- 自动重定向到登录页
- 保存用户意图的访问路径

## 系统架构

```
用户访问页面
    ↓
auth-guard.js 检查
    ↓
已登录？
    ├─ 是 → 允许访问
    └─ 否 → 显示登录提示 → 重定向到登录页
```

## 安全特性

1. **Token验证**：检查localStorage和sessionStorage中的token
2. **数据完整性**：验证用户数据的JSON格式
3. **自动清理**：清除无效的会话数据
4. **返回URL**：登录后自动返回原页面
5. **友好提示**：美观的登录提示界面

## 受保护的页面

- `divination.html` - AI占卜
- `fengshui.html` - 风水分析
- `iching.html` - 易经卦象
- `profile.html` - 个人档案

## 公开页面

- `index.html` - 首页
- `login.html` - 登录页
- `payment.html` - 支付页
- `terms.html` - 服务条款
- `privacy.html` - 隐私政策

## 实现细节

### Token存储策略
- **localStorage**：记住我功能，长期有效
- **sessionStorage**：临时会话，关闭浏览器后失效

### 用户体验优化
- 全屏遮罩提示
- 金色主题设计
- 平滑动画效果
- 禁止页面滚动

### 错误处理
- 无效token自动清理
- JSON解析错误处理
- 网络错误容错

## 使用方法

### 1. 在受保护页面引入守卫
```html
<!-- 在</body>标签前引入 -->
<script src="auth-guard.js"></script>
```

### 2. 手动检查登录状态
```javascript
// 检查用户是否登录
const authStatus = AuthGuard.isLoggedIn();
if (authStatus.loggedIn) {
    console.log('用户已登录:', authStatus.user.email);
}
```

### 3. 手动重定向到登录
```javascript
// 需要登录时手动重定向
AuthGuard.redirectToLogin(window.location.pathname);
```

## 配置选项

### 修改受保护页面列表
在 `auth-guard.js` 中修改 `PROTECTED_PAGES` 数组：
```javascript
const PROTECTED_PAGES = [
    'divination.html',
    'fengshui.html',
    'iching.html',
    'profile.html',
    // 添加更多页面...
];
```

### 自定义登录提示样式
修改 `showLoginPrompt()` 函数中的CSS样式。

## 测试场景

### 场景1：未登录访问受保护页面
1. 清除浏览器存储
2. 访问 `divination.html`
3. 应显示登录提示遮罩
4. 点击"立即登录"跳转到登录页

### 场景2：已登录访问受保护页面
1. 登录系统
2. 访问 `divination.html`
3. 应正常显示页面内容

### 场景3：登录后返回原页面
1. 未登录访问 `fengshui.html`
2. 重定向到登录页
3. 登录成功后自动返回 `fengshui.html`

### 场景4：Token过期处理
1. 手动修改localStorage中的token为无效值
2. 刷新页面
3. 应清除无效数据并显示登录提示

## 安全建议

1. **HTTPS部署**：生产环境必须使用HTTPS
2. **Token加密**：考虑对敏感数据加密存储
3. **定期刷新**：实现token自动刷新机制
4. **后端验证**：前端验证只是第一道防线，后端API必须验证token
5. **XSS防护**：避免在localStorage中存储敏感信息
6. **CSRF防护**：实现CSRF token机制

## 维护和扩展

### 添加新的受保护页面
1. 在页面HTML中引入 `auth-guard.js`
2. 将页面文件名添加到 `PROTECTED_PAGES` 数组

### 自定义认证逻辑
修改 `isUserLoggedIn()` 函数以适应不同的认证方案。

### 集成后端API
在 `auth-service.js` 中添加API调用逻辑：
```javascript
async function validateToken(token) {
    const response = await fetch('/api/auth/validate', {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    return response.ok;
}
```

## 故障排除

### 问题：登录后仍显示登录提示
- 检查localStorage中是否有token和user数据
- 验证JSON格式是否正确
- 查看浏览器控制台错误信息

### 问题：无法重定向到登录页
- 确认login.html文件存在
- 检查文件路径是否正确
- 查看浏览器控制台错误

### 问题：返回URL不工作
- 检查sessionStorage中的return_url
- 确认登录页面正确处理return参数

## 性能优化

1. **延迟加载**：守卫脚本在DOM加载后执行
2. **缓存策略**：合理使用localStorage减少API调用
3. **最小化重定向**：避免重定向循环

## 浏览器兼容性

- Chrome 60+
- Firefox 55+
- Safari 11+
- Edge 79+

## 更新日志

### v1.0.0 (当前版本)
- 基础认证守卫功能
- 登录提示界面
- 返回URL支持
- Token验证机制
