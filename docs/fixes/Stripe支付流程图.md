# Stripe 支付流程图

## 完整支付流程

```
┌─────────────────────────────────────────────────────────────┐
│                     用户浏览商品                              │
│                  (fengshui.html)                             │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              用户点击"立即购买"或"加入购物车"                  │
│                   (shop-ui.js)                               │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                显示结账模态框                                 │
│           showCheckoutModal(items)                           │
│                                                              │
│  • 显示商品列表                                               │
│  • 收货地址表单                                               │
│  • 订单摘要                                                   │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              用户填写收货信息并提交                            │
│                                                              │
│  • 收货人姓名                                                 │
│  • 联系电话                                                   │
│  • 详细地址                                                   │
│  • 备注（可选）                                               │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│          handleCheckout(form, items, totalAmount)            │
│                                                              │
│  1. 收集表单数据                                              │
│  2. 构建订单数据对象                                          │
│  3. ✅ 验证必填字段                                           │
│  4. 关闭结账模态框                                            │
│  5. 调用 showStripePayment()                                 │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│       showStripePayment(items, totalAmount, orderData)       │
│                                                              │
│  1. 创建支付模态框                                            │
│  2. 显示订单摘要                                              │
│  3. 初始化 Stripe 卡片元素                                    │
│  4. 绑定表单提交事件                                          │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              用户填写支付信息                                 │
│                                                              │
│  • 卡号: 4242 4242 4242 4242                                 │
│  • 到期日期: 12/34                                           │
│  • CVC: 123                                                  │
│  • 邮编: 12345                                               │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              用户点击"支付"按钮                               │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│    processStripePayment(items, totalAmount, orderData)       │
│                                                              │
│  步骤 1: 创建支付意图                                         │
│  ├─ 调用 StripePaymentService.createPaymentIntent()         │
│  ├─ 金额转换为分 (amount * 100)                              │
│  └─ 获取 clientSecret                                        │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                  Stripe API 处理                             │
│         (stripe-client.js → Stripe Server)                   │
│                                                              │
│  • 验证卡片信息                                               │
│  • 创建 Payment Intent                                       │
│  • 返回 clientSecret                                         │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│    processStripePayment (继续)                               │
│                                                              │
│  步骤 2: 确认支付                                             │
│  ├─ 调用 StripePaymentService.confirmPayment()              │
│  ├─ 使用 clientSecret 和卡片元素                             │
│  └─ 获取 paymentIntent                                       │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                  Stripe 处理支付                             │
│                                                              │
│  • 验证卡片                                                   │
│  • 扣款                                                       │
│  • 返回支付结果                                               │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│    processStripePayment (继续)                               │
│                                                              │
│  步骤 3: 创建订单记录                                         │
│  ├─ 更新 orderData                                           │
│  │  ├─ payment_method: 'stripe'                             │
│  │  ├─ payment_status: 'paid'                               │
│  │  ├─ stripe_payment_intent_id                             │
│  │  └─ status: 'confirmed'                                  │
│  └─ 调用 ShopService.orders.create()                        │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                  Supabase 数据库                             │
│                                                              │
│  • 插入订单记录到 orders 表                                   │
│  • 生成订单号                                                 │
│  • 返回订单 ID                                                │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│    processStripePayment (继续)                               │
│                                                              │
│  步骤 4: 创建订单明细                                         │
│  ├─ 调用 createOrderItems(orderId, items)                   │
│  └─ 插入每个商品到 order_items 表                            │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│    processStripePayment (继续)                               │
│                                                              │
│  步骤 5: 清空购物车                                           │
│  └─ 调用 ShopService.cart.clear()                           │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│    processStripePayment (继续)                               │
│                                                              │
│  步骤 6: 显示成功消息                                         │
│  ├─ 关闭支付模态框                                            │
│  ├─ 显示成功提示                                              │
│  ├─ 显示订单号                                                │
│  └─ 刷新购物车计数                                            │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                    支付完成！                                 │
│                                                              │
│  ✅ 订单已创建                                                │
│  ✅ 支付已完成                                                │
│  ✅ 购物车已清空                                              │
│  ✅ 用户收到确认                                              │
└─────────────────────────────────────────────────────────────┘
```

## 关键方法调用链

```
用户操作
  │
  ├─ buyNow(productId)
  │   └─ showCheckoutModal([item])
  │
  └─ viewCart()
      └─ showCartModal()
          └─ proceedToCheckout()
              └─ showCheckoutModal(cartItems)
                  │
                  └─ 用户提交表单
                      │
                      └─ handleCheckout(form, items, totalAmount)
                          │
                          ├─ 收集订单数据
                          ├─ 验证必填字段 ✅
                          │
                          └─ showStripePayment(items, totalAmount, orderData)
                              │
                              ├─ 创建支付模态框
                              ├─ 初始化 Stripe 元素
                              │
                              └─ 用户提交支付
                                  │
                                  └─ processStripePayment(items, totalAmount, orderData)
                                      │
                                      ├─ createPaymentIntent()
                                      ├─ confirmPayment()
                                      ├─ orders.create()
                                      ├─ createOrderItems()
                                      ├─ cart.clear()
                                      └─ showSuccessMessage()
```

## 数据流

```
┌──────────────┐
│   用户输入    │
│              │
│ • 商品选择    │
│ • 收货信息    │
│ • 支付信息    │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  前端验证     │
│              │
│ • 必填字段    │
│ • 格式检查    │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ Stripe API   │
│              │
│ • 创建意图    │
│ • 确认支付    │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  Supabase    │
│              │
│ • 订单记录    │
│ • 订单明细    │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  用户反馈     │
│              │
│ • 成功消息    │
│ • 订单号      │
└──────────────┘
```

## 错误处理流程

```
任何步骤发生错误
  │
  ├─ 捕获异常
  │
  ├─ 记录错误日志
  │   console.error('错误信息')
  │
  ├─ 显示用户友好的错误消息
  │   alert('支付失败: ' + error.message)
  │
  ├─ 恢复 UI 状态
  │   ├─ 启用提交按钮
  │   ├─ 隐藏加载动画
  │   └─ 显示按钮文本
  │
  └─ 允许用户重试
```

## 测试流程

```
┌─────────────────────────────────────────┐
│         启动测试                         │
│   test-shop-stripe.bat                  │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│   测试 1: Stripe 初始化                  │
│   • Stripe.js 已加载                     │
│   • StripePaymentService 已初始化        │
│   • Stripe 实例已创建                    │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│   测试 2: ShopUI 初始化                  │
│   • ShopUI 已初始化                      │
│   • handleCheckout 方法存在              │
│   • showStripePayment 方法存在           │
│   • processStripePayment 方法存在        │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│   测试 3: 结账流程                       │
│   • 创建测试商品                         │
│   • 显示结账模态框                       │
│   • 填写收货信息                         │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│   测试 4: Stripe 支付                    │
│   • 显示支付页面                         │
│   • 填写测试卡号                         │
│   • 完成支付                             │
│   • 验证订单创建                         │
└─────────────┬───────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────┐
│         测试完成                         │
│   ✅ 所有测试通过                        │
└─────────────────────────────────────────┘
```

## 修复前后对比

### 修复前 ❌

```javascript
async handleCheckout(form, items, totalAmount) {
    // 收集订单数据
    const orderData = { ... };
    
    // ❌ 直接创建订单，没有支付
    const result = await ShopService.orders.create(orderData);
    
    // 显示成功消息
    this.showSuccessMessage(result.data.order_number);
}
```

### 修复后 ✅

```javascript
async handleCheckout(form, items, totalAmount) {
    // 收集订单数据
    const orderData = { ... };
    
    // ✅ 验证必填字段
    if (!orderData.recipient_name || !orderData.recipient_phone || !orderData.shipping_address) {
        throw new Error('请填写完整的收货信息');
    }
    
    // ✅ 显示 Stripe 支付页面
    this.showStripePayment(items, totalAmount, orderData);
}
```

## 总结

修复完成后，支付流程现在包含以下关键步骤：

1. ✅ **收集订单信息** - handleCheckout()
2. ✅ **验证必填字段** - 新增验证逻辑
3. ✅ **显示支付页面** - showStripePayment()
4. ✅ **处理支付流程** - processStripePayment()
5. ✅ **创建订单记录** - ShopService.orders.create()
6. ✅ **清空购物车** - ShopService.cart.clear()
7. ✅ **显示成功消息** - showSuccessMessage()

整个流程流畅、安全、用户友好！
