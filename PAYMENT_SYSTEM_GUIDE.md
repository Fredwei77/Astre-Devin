# 支付系统使用指南

## 📋 概述

九筮支付系统支持两种模式：
- **生产模式**：连接真实的 Stripe API 进行支付
- **测试模式**：模拟支付流程，无需真实支付（自动启用于本地开发）

## 🚀 快速开始

### 1. 打开测试页面

访问 `test-premium-payment.html` 进行支付功能测试。

### 2. 测试模式说明

系统会在以下情况自动启用测试模式：
- 在 localhost 或 127.0.0.1 运行
- 后端服务器未启动
- 网络连接失败
- 手动启用测试模式开关

### 3. 测试功能

#### 订阅测试
- **Premium 高级版** ($19.99/月)
  - 完整AI分析功能
  - 无限次数使用
  - 专家咨询 (2次/月)

- **Professional 专业版** ($49.99/月)
  - 所有高级版功能
  - API访问权限
  - 定制报告
  - 优先支持

#### 按次付费测试
- **AI占卜** - $0.99/次
- **风水分析** - $1.99/次
- **易经智慧** - $2.99/次

#### 权限测试
- 测试AI功能访问
- 测试每日使用限制
- 测试升级提示
- 测试单次使用权限

## 🔧 配置说明

### 环境变量 (.env)

```env
# Stripe 配置
STRIPE_SECRET_KEY=sk_test_your_secret_key
STRIPE_PUBLISHABLE_KEY=pk_test_your_publishable_key
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret

# 服务器配置
PORT=3000
FRONTEND_URL=http://localhost:8080

# JWT 配置
JWT_SECRET=your_jwt_secret_key
```

### 启动后端服务器

```bash
# 安装依赖
npm install

# 启动服务器
npm start

# 或使用快速启动脚本
start.bat
```

## 📝 测试流程

### 1. 订阅测试流程

1. 点击"测试订阅"按钮
2. 填写测试信息：
   - 姓名：任意
   - 邮箱：任意有效邮箱格式
   - 支付信息：测试模式下会自动模拟
3. 点击"订阅"按钮
4. 等待处理（测试模式约1.5秒）
5. 查看成功提示

### 2. 按次付费测试流程

1. 点击"测试支付"按钮
2. 在弹出的升级提示中选择"立即支付"
3. 系统自动处理支付
4. 授予单次使用权限
5. 可以使用对应服务

### 3. 权限测试流程

1. **测试AI访问**：检查当前用户是否有AI功能权限
2. **测试每日限制**：检查免费用户的使用次数限制
3. **测试升级提示**：显示升级到高级版的提示
4. **测试单次权限**：检查按次付费的使用权限

## 🎯 状态管理

### 快速切换计划

- **设为免费版**：模拟免费用户状态
- **设为高级版**：模拟 Premium 会员
- **设为专业版**：模拟 Professional 会员

### 数据管理

- **重置使用次数**：清除今日使用记录
- **清除单次权限**：清除所有按次付费权限
- **清除所有数据**：重置所有测试数据

### 测试模式开关

在测试页面底部可以手动切换测试模式：
- **启用**：所有支付请求都会被模拟
- **禁用**：尝试连接真实的 Stripe API

## 🔍 调试信息

### 查看日志

测试页面底部的"测试日志"区域会显示：
- ✅ 成功操作（绿色）
- ❌ 错误信息（红色）
- ⚠️ 警告信息（黄色）
- ℹ️ 一般信息（蓝色）

### 浏览器控制台

打开浏览器开发者工具（F12）查看详细日志：
- 支付请求详情
- API 响应数据
- 错误堆栈信息

## 📦 文件说明

### 核心文件

- `stripe-client-enhanced.js` - 增强版 Stripe 客户端（支持测试模式）
- `subscription-manager.js` - 订阅管理器
- `payment-ui.js` - 支付界面组件
- `test-premium-payment.html` - 支付测试页面

### 后端文件

- `server.js` - Express 服务器
- `stripe-api.js` - Stripe API 路由
- `.env` - 环境变量配置

## 🚨 常见问题

### Q: 为什么显示"Failed to fetch"？

A: 这通常表示后端服务器未启动。系统会自动切换到测试模式继续工作。

### Q: 测试模式下的支付是真实的吗？

A: 不是。测试模式下所有支付都是模拟的，不会产生真实费用。

### Q: 如何切换到生产模式？

A: 
1. 确保后端服务器正在运行
2. 配置正确的 Stripe 密钥
3. 关闭测试模式开关
4. 使用真实的支付信息

### Q: 订阅后如何取消？

A: 在用户个人中心（profile.html）可以管理订阅，包括取消订阅。

## 🔐 安全注意事项

### 测试环境

- ✅ 使用 Stripe 测试密钥
- ✅ 不要使用真实的支付信息
- ✅ 测试数据不会影响生产环境

### 生产环境

- ⚠️ 使用 Stripe 生产密钥
- ⚠️ 启用 HTTPS
- ⚠️ 配置 Webhook 签名验证
- ⚠️ 实施速率限制
- ⚠️ 记录所有支付事件

## 📞 技术支持

如遇到问题，请检查：
1. 浏览器控制台错误信息
2. 测试日志输出
3. 后端服务器日志
4. Stripe Dashboard 事件日志

## 🎉 测试建议

### 推荐测试场景

1. **免费用户升级流程**
   - 设为免费版
   - 尝试使用AI功能
   - 查看升级提示
   - 完成订阅

2. **按次付费流程**
   - 设为免费版
   - 点击按次付费
   - 完成支付
   - 使用服务

3. **每日限制测试**
   - 设为免费版
   - 多次使用服务
   - 达到限制后查看提示

4. **订阅管理**
   - 订阅高级版
   - 查看订阅状态
   - 取消订阅
   - 验证权限变化

---

**版本**: 1.0.0  
**更新日期**: 2024-12-08  
**维护者**: 九筮开发团队
